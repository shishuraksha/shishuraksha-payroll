<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shishuraksha Children's Hospital - Premium Payroll Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --backdrop-blur: blur(20px);
            
            --shadow-elevation-1: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-elevation-2: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-elevation-3: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
            color: #1e293b;
        }

        body.dark-mode {
            background: #0f172a;
            color: #f1f5f9;
        }

        .glass-morphism {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-elevation-2);
        }

        .glass-morphism-strong {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-elevation-3);
        }

        .dark-mode .glass-morphism {
            background: rgba(30, 30, 45, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-mode .glass-morphism-strong {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .premium-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .premium-card {
            background: #1e293b;
            border: 1px solid #334155;
        }

        .premium-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-premium {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-premium:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-premium:active {
            transform: translateY(0);
        }

        .nav-tab {
            position: relative;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 24px;
            color: #64748b;
            transition: all 0.2s ease;
            margin: 0 4px;
            cursor: pointer;
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .dark-mode .nav-tab {
            border-color: #475569;
            color: #94a3b8;
        }

        .dark-mode .nav-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .attendance-cell {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attendance-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .attendance-P {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .attendance-A {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: white;
        }

        .attendance-Off {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
        }

        .attendance-OT {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .attendance-POT {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .table-premium {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .table-premium {
            background: #1e293b;
            border: 1px solid #334155;
        }

        .table-premium th {
            background: #f1f5f9;
            color: #374151;
            font-weight: 600;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dark-mode .table-premium th {
            background: #334155;
            color: #f1f5f9;
            border-bottom: 1px solid #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-premium td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 400;
            font-size: 14px;
            text-align: left;
            vertical-align: middle;
        }

        .dark-mode .table-premium td {
            color: #e2e8f0;
            border-bottom: 1px solid #475569;
        }

        /* Advance input field styling */
        .advance-input {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            outline: none;
        }

        .advance-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: #ffffff;
        }

        .advance-input:hover {
            border-color: #94a3b8;
        }

        .dark-mode .advance-input {
            background: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .dark-mode .advance-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
            background: #1e293b;
        }

        .dark-mode .advance-input:hover {
            border-color: #64748b;
        }

        .notification {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            box-shadow: var(--shadow-elevation-3);
            animation: slideInRight 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease;
        }

        .dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }

        @keyframes modalSlideIn {
            from {
                transform: translate(-50%, -60%) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            white-space: nowrap;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Attendance table specific styles */
        .attendance-table-container {
            max-height: 70vh;
            overflow: auto;
        }

        .attendance-cell {
            min-width: 32px;
            min-height: 32px;
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .premium-card {
                margin: 8px;
                border-radius: 16px;
                padding: 16px;
            }
            
            .btn-premium {
                padding: 10px 20px;
                font-size: 12px;
            }
            
            .table-premium {
                font-size: 11px;
            }
            
            .table-premium th,
            .table-premium td {
                padding: 8px;
                white-space: nowrap;
            }
            
            /* Enhanced scrolling for touch devices */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .attendance-cell {
                width: 24px;
                height: 24px;
                font-size: 8px;
                min-width: 24px;
                min-height: 24px;
            }

            .nav-tab {
                padding: 8px 16px;
                font-size: 12px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }

            .attendance-table-container {
                max-height: 60vh;
            }
        }

        @media (max-width: 480px) {
            .table-premium {
                font-size: 10px;
            }
            
            .table-premium th,
            .table-premium td {
                padding: 6px;
                font-size: 10px;
            }
            
            .attendance-cell {
                width: 20px;
                height: 20px;
                font-size: 7px;
                min-width: 20px;
                min-height: 20px;
            }
        }
        
        /* Enhanced table container for better UX */
        .table-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Scroll indicator for tables */
        .overflow-x-auto::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .overflow-x-auto:hover::after {
            opacity: 1;
        }

        /* Keyboard navigation */
        .focusable:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .premium-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6b5b95);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Premium Header -->
    <header class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 no-print">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center py-4 sm:py-6">
                <div class="flex items-center space-x-4 sm:space-x-6 mb-4 sm:mb-0">
                    <div class="relative">
                        <div class="w-12 sm:w-16 h-12 sm:h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-hospital text-white text-xl sm:text-2xl"></i>
                        </div>
                        <div class="absolute -top-2 -right-2 w-5 sm:w-6 h-5 sm:h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-3xl font-black text-gray-900 dark:text-white">
                            Shishuraksha Children's Hospital
                        </h1>
                        <p class="text-gray-600 dark:text-gray-300 font-semibold mt-1 text-sm sm:text-base">Premium Payroll Management System</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 sm:space-x-6">
                    <!-- Month Selector -->
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-2">
                        <select id="monthSelector" onchange="changeMonth()" class="bg-transparent text-gray-900 dark:text-white border-none outline-none font-medium text-sm px-3 py-2 focusable">
                            <option value="2025-01" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">January 2025</option>
                            <option value="2025-02" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">February 2025</option>
                            <option value="2025-03" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">March 2025</option>
                            <option value="2025-04" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">April 2025</option>
                            <option value="2025-05" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">May 2025</option>
                            <option value="2025-06" selected class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">June 2025</option>
                            <option value="2025-07" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">July 2025</option>
                            <option value="2025-08" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">August 2025</option>
                            <option value="2025-09" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">September 2025</option>
                            <option value="2025-10" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">October 2025</option>
                            <option value="2025-11" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">November 2025</option>
                            <option value="2025-12" class="text-gray-900 dark:text-white bg-white dark:bg-gray-800">December 2025</option>
                        </select>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="bg-gray-100 dark:bg-gray-800 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center text-gray-900 dark:text-white rounded-lg focusable hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Toggle dark mode">
                        <i id="darkModeIcon" class="fas fa-moon"></i>
                    </button>
                    
                    <!-- Action Buttons -->
                    <div class="hidden sm:flex space-x-3">
                        <button onclick="processPayroll()" class="btn-premium focusable">
                            <i class="fas fa-calculator mr-2"></i>Process Payroll
                        </button>
                        <button onclick="exportAllData()" class="btn-premium focusable" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                            <i class="fas fa-download mr-2"></i>Export All
                        </button>
                    </div>

                    <!-- Mobile Menu Button -->
                    <button onclick="toggleMobileMenu()" class="sm:hidden bg-gray-100 dark:bg-gray-800 w-10 h-10 flex items-center justify-center text-gray-900 dark:text-white rounded-lg focusable hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm sm:hidden">
        <div class="glass-morphism-strong h-full w-64 p-6">
            <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="mt-12 space-y-4">
                <button onclick="processPayroll(); toggleMobileMenu();" class="btn-premium w-full">
                    <i class="fas fa-calculator mr-2"></i>Process Payroll
                </button>
                <button onclick="exportAllData(); toggleMobileMenu();" class="btn-premium w-full" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                    <i class="fas fa-download mr-2"></i>Export All
                </button>
                <button onclick="saveMonthlyPayroll(); toggleMobileMenu();" class="btn-premium w-full" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);">
                    <i class="fas fa-save mr-2"></i>Save Month
                </button>
                <button onclick="generateGovernmentFiles(); toggleMobileMenu();" class="btn-premium w-full" style="background: linear-gradient(135deg, #fb7185, #f43f5e);">
                    <i class="fas fa-file-contract mr-2"></i>Gov Files
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-gray-700 sticky top-[88px] sm:top-[104px] z-40 no-print">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-2 sm:space-x-3 overflow-x-auto py-4 sm:py-6 scrollbar-hide">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="nav-tab active focusable">
                    <i class="fas fa-chart-line mr-1 sm:mr-2"></i><span class="hidden sm:inline">Dashboard</span><span class="sm:hidden">Dash</span>
                </button>
                <button onclick="switchTab('employees')" id="tab-employees" class="nav-tab focusable">
                    <i class="fas fa-users mr-1 sm:mr-2"></i><span class="hidden sm:inline">Employees</span><span class="sm:hidden">Emp</span>
                </button>
                <button onclick="switchTab('attendance')" id="tab-attendance" class="nav-tab focusable">
                    <i class="fas fa-calendar-check mr-1 sm:mr-2"></i><span class="hidden sm:inline">Attendance</span><span class="sm:hidden">Attend</span>
                </button>
                <button onclick="switchTab('payroll')" id="tab-payroll" class="nav-tab focusable">
                    <i class="fas fa-money-bill-wave mr-1 sm:mr-2"></i><span class="hidden sm:inline">Payroll</span><span class="sm:hidden">Pay</span>
                </button>
                <button onclick="switchTab('reports')" id="tab-reports" class="nav-tab focusable">
                    <i class="fas fa-file-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Reports</span><span class="sm:hidden">Rep</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
        
        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                <!-- Total Employees Card -->
                <div class="premium-card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Total registered employees</span>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-gray-900 dark:text-white mb-2" id="total-employees">70</div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Total Employees</p>
                    <div class="mt-4 flex items-center text-sm">
                        <div class="flex items-center text-green-600">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span>+2 this month</span>
                        </div>
                    </div>
                </div>

                <!-- Gross Payroll Card -->
                <div class="premium-card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-calculator text-white text-xl"></i>
                        </div>
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Total gross salary</span>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-gray-900 dark:text-white mb-2" id="gross-payroll">₹0</div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Gross Payroll</p>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: 0%" id="payroll-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Net Payroll Card -->
                <div class="premium-card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-rupee-sign text-white text-xl"></i>
                        </div>
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Net amount to be paid</span>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-gray-900 dark:text-white mb-2" id="total-net-pay">₹0</div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Net Payroll</p>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-emerald-600 font-semibold">Ready to pay</span>
                    </div>
                </div>

                <!-- Deductions Card -->
                <div class="premium-card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-minus-circle text-white text-xl"></i>
                        </div>
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Total deductions</span>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-gray-900 dark:text-white mb-2" id="total-deductions">₹0</div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Total Deductions</p>
                    <div class="mt-4 text-sm text-gray-500">
                        <span id="deduction-percentage">0%</span> of gross pay
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Department Distribution Chart -->
                <div class="premium-card p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Department Distribution</h3>
                    <canvas id="departmentChart" width="400" height="200"></canvas>
                </div>

                <!-- Salary Range Chart -->
                <div class="premium-card p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Salary Range Distribution</h3>
                    <canvas id="salaryRangeChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="premium-card p-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Recent Activities</h3>
                <div id="recentActivities" class="space-y-3">
                    <!-- Activities will be populated here -->
                </div>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="content-employees" class="tab-content hidden">
            <div class="premium-card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 sm:mb-0">Employee Master</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                        <input type="text" id="employeeSearch" placeholder="Search employees..." 
                               class="w-full sm:w-64 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500" 
                               onkeyup="searchEmployees()">
                        <button onclick="showAddEmployeeModal()" class="btn-premium focusable">
                            <i class="fas fa-plus mr-2"></i>Add Employee
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="table-premium w-full">
                        <thead>
                            <tr>
                                <th class="cursor-pointer" onclick="sortEmployees('id')">ID <i class="fas fa-sort"></i></th>
                                <th class="cursor-pointer" onclick="sortEmployees('name')">Name <i class="fas fa-sort"></i></th>
                                <th>Department</th>
                                <th>Designation</th>
                                <th>Bank Account</th>
                                <th>IFSC</th>
                                <th>Basic Salary</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <!-- Employee rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="content-attendance" class="tab-content hidden">
            <div class="premium-card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 sm:mb-0">Attendance Management</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <!-- Bulk Attendance Buttons -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="bulkMarkAttendance('P')" class="btn-premium focusable text-xs px-3 py-2" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                                <i class="fas fa-check mr-1"></i>All Present
                            </button>
                            <button onclick="bulkMarkAttendance('A')" class="btn-premium focusable text-xs px-3 py-2" style="background: linear-gradient(135deg, #f87171, #ef4444);">
                                <i class="fas fa-times mr-1"></i>All Absent
                            </button>
                            <button onclick="bulkMarkAttendance('Off')" class="btn-premium focusable text-xs px-3 py-2" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);">
                                <i class="fas fa-calendar-times mr-1"></i>All Off
                            </button>
                            <button onclick="clearAllAttendance()" class="btn-premium focusable text-xs px-3 py-2" style="background: linear-gradient(135deg, #64748b, #475569);">
                                <i class="fas fa-eraser mr-1"></i>Clear All
                            </button>
                        </div>
                        <!-- Utility Buttons -->
                        <div class="flex gap-2">
                            <button onclick="markTodayAttendance()" class="btn-premium focusable">
                                <i class="fas fa-calendar-day mr-2"></i>Mark Today
                            </button>
                            <button onclick="showDepartmentAttendance()" class="btn-premium focusable" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                                <i class="fas fa-building mr-2"></i>By Dept
                            </button>
                            <button onclick="importAttendance()" class="btn-premium focusable">
                                <i class="fas fa-upload mr-2"></i>Import
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Box for Attendance -->
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Employee</label>
                            <input type="text" 
                                   id="attendanceSearch" 
                                   placeholder="Search by name, ID, or department..." 
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                   onkeyup="searchAttendance()">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearAttendanceSearch()" class="btn-premium">
                                <i class="fas fa-times mr-2"></i>Clear Search
                            </button>
                            <button onclick="highlightEmployee()" class="btn-premium" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-search mr-2"></i>Find & Highlight
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Attendance Legend -->
                <div class="flex flex-wrap items-center space-x-4 mb-6 text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="attendance-cell attendance-P">P</div>
                        <span class="text-gray-600 dark:text-gray-400">Present</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="attendance-cell attendance-A">A</div>
                        <span class="text-gray-600 dark:text-gray-400">Absent</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="attendance-cell attendance-Off">Off</div>
                        <span class="text-gray-600 dark:text-gray-400">Weekly Off</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="attendance-cell attendance-OT">OT</div>
                        <span class="text-gray-600 dark:text-gray-400">Overtime</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="attendance-cell attendance-POT">POT</div>
                        <span class="text-gray-600 dark:text-gray-400">Present + OT</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto attendance-table-container">
                    <table class="table-premium w-full">
                        <thead>
                            <!-- Header will be dynamically generated -->
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Attendance rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payroll Tab -->
        <div id="content-payroll" class="tab-content hidden">
            <div class="premium-card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 sm:mb-0">Payroll Sheet</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button onclick="processPayroll()" class="btn-premium focusable">
                            <i class="fas fa-calculator mr-2"></i>Calculate
                        </button>
                        <button onclick="exportPayroll()" class="btn-premium focusable" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                            <i class="fas fa-file-excel mr-2"></i>Export
                        </button>
                    </div>
                </div>

                <!-- Search Box for Payroll -->
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Employee</label>
                            <input type="text" 
                                   id="payrollSearch" 
                                   placeholder="Search by name, ID, department, or net pay amount..." 
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                   onkeyup="searchPayroll()">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearPayrollSearch()" class="btn-premium">
                                <i class="fas fa-times mr-2"></i>Clear Search
                            </button>
                            <button onclick="showEmployeePayDetails()" class="btn-premium" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fas fa-eye mr-2"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="table-premium w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Days</th>
                                <th>Basic</th>
                                <th>HRA</th>
                                <th>Conv.</th>
                                <th>Other</th>
                                <th>OT Amt</th>
                                <th>Gross</th>
                                <th>PF</th>
                                <th>ESIC</th>
                                <th>PT</th>
                                <th>Advance</th>
                                <th>Total Ded.</th>
                                <th>Net Pay</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <!-- Payroll rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="content-reports" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Payslips -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-file-pdf text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Payslips</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Generate individual payslips</p>
                        </div>
                    </div>
                    <button onclick="showPayslipSelector()" class="btn-premium w-full focusable">
                        <i class="fas fa-download mr-2"></i>Generate Payslips
                    </button>
                </div>

                <!-- Bank Statement -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-university text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Bank Statement</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Export bank payment file</p>
                        </div>
                    </div>
                    <button onclick="generateBankStatement()" class="btn-premium w-full focusable" style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                        <i class="fas fa-download mr-2"></i>Generate Statement
                    </button>
                </div>

                <!-- Government Files -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-file-contract text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Government Files</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">PF, ESIC, PT returns</p>
                        </div>
                    </div>
                    <button onclick="generateGovernmentFiles()" class="btn-premium w-full focusable" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);">
                        <i class="fas fa-download mr-2"></i>Generate Files
                    </button>
                </div>

                <!-- Department Summary -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-chart-pie text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Department Summary</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Department-wise analysis</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateDepartmentSummary()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                        <button onclick="generateDepartmentReport()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #d97706, #b45309);">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                    </div>
                </div>

                <!-- Attendance Report -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-check text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Attendance Report</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Monthly attendance summary</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateAttendanceReport()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #fb7185, #f43f5e);">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                        <button onclick="generateAttendanceReportPDF()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                    </div>
                </div>

                <!-- Comprehensive Report -->
                <div class="premium-card p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-file-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Master Report</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">All data in one report</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateComprehensiveReport()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                        <button onclick="generateComprehensiveReportPDF()" class="btn-premium flex-1 focusable" style="background: linear-gradient(135deg, #4338ca, #3730a3);">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="hidden fixed inset-0 z-50 modal-backdrop">
        <div class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Add New Employee</h3>
            <form id="addEmployeeForm" onsubmit="addEmployee(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Employee ID</label>
                        <input type="text" name="id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                        <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Department</label>
                        <select name="department" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Accounts">Accounts</option>
                            <option value="Sales">Sales</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Designation</label>
                        <input type="text" name="designation" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Bank Account</label>
                        <input type="text" name="bankAccount" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">IFSC Code</label>
                        <input type="text" name="ifsc" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Basic Salary</label>
                        <input type="number" name="basicSalary" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <select name="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('addEmployeeModal')" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="btn-premium">
                        <i class="fas fa-save mr-2"></i>Save Employee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payslip Selector Modal -->
    <div id="payslipModal" class="hidden fixed inset-0 z-50 modal-backdrop">
        <div class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Generate Payslips</h3>
            <div class="mb-4">
                <input type="text" id="payslipSearch" placeholder="Search employees..." 
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500" 
                       onkeyup="filterPayslipEmployees()">
            </div>
            <div class="mb-4">
                <button onclick="selectAllPayslips(true)" class="btn-premium mr-2">Select All</button>
                <button onclick="selectAllPayslips(false)" class="btn-premium" style="background: linear-gradient(135deg, #f87171, #ef4444);">Deselect All</button>
            </div>
            <div id="payslipEmployeeList" class="space-y-2 mb-6">
                <!-- Employee checkboxes will be populated here -->
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('payslipModal')" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button onclick="generateSelectedPayslips()" class="btn-premium">
                    <i class="fas fa-file-pdf mr-2"></i>Generate Selected
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let employees = [];
        let attendance = {};
        let payrollData = [];
        let currentMonth = '2025-06';
        let activities = [];
        let darkMode = false;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupKeyboardShortcuts();
            setupAutoSave();
        });

        function initializeApp() {
            const dataLoaded = loadFromLocalStorage();
            if (!dataLoaded || employees.length === 0) {
                generateSampleData();
                console.log('No saved data found, generated sample data');
            }
            updateDashboard();
            displayEmployees();
            displayAttendance();
            initializeCharts();
            checkDataIntegrity();
        }

        // Local Storage Functions
        function saveToLocalStorage() {
            try {
                const data = {
                    employees: employees,
                    attendance: attendance,
                    payrollData: payrollData,
                    activities: activities,
                    darkMode: darkMode,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('payrollSystemData', JSON.stringify(data));
                addActivity('Data auto-saved');
                return true;
            } catch (error) {
                console.error('Failed to save data to localStorage:', error);
                if (error.name === 'QuotaExceededError') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Storage Full',
                        text: 'Unable to save data - browser storage is full. Please clear some data or export your records.',
                        showConfirmButton: true
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Save Error',
                        text: 'Unable to save your data. Please try again or export your records as backup.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('payrollSystemData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data && typeof data === 'object') {
                        employees = Array.isArray(data.employees) ? data.employees : [];
                        attendance = (data.attendance && typeof data.attendance === 'object') ? data.attendance : {};
                        payrollData = Array.isArray(data.payrollData) ? data.payrollData : [];
                        activities = Array.isArray(data.activities) ? data.activities : [];
                        darkMode = data.darkMode || false;
                        if (darkMode) {
                            document.body.classList.add('dark-mode');
                            const darkModeIcon = document.getElementById('darkModeIcon');
                            if (darkModeIcon) {
                                darkModeIcon.className = 'fas fa-sun';
                            }
                        }
                        console.log('Data loaded successfully from localStorage');
                        return true; // Indicate successful load
                    }
                }
            } catch (error) {
                console.error('Failed to load data from localStorage:', error);
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Load Error',
                    text: 'There was an issue loading your saved data. Starting with default settings.',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
            return false; // Indicate failed load
        }

        // Auto-save every 30 seconds
        function setupAutoSave() {
            setInterval(() => {
                saveToLocalStorage();
            }, 30000);
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            icon.className = darkMode ? 'fas fa-sun' : 'fas fa-moon';
            saveToLocalStorage();
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Generate Sample Data
        function generateSampleData() {
            if (employees.length === 0) {
                const departments = ['IT', 'HR', 'Accounts', 'Sales', 'Marketing'];
                const designations = ['Manager', 'Executive', 'Senior Executive', 'Team Lead', 'Director'];
                const names = [
                    'Rajesh Kumar', 'Priya Sharma', 'Amit Patel', 'Sunita Reddy', 'Vikram Singh',
                    'Anita Desai', 'Suresh Iyer', 'Kavita Mehta', 'Ramesh Gupta', 'Deepa Nair'
                ];

                for (let i = 1; i <= 70; i++) {
                    employees.push({
                        id: `EMP${String(i).padStart(3, '0')}`,
                        name: names[i % names.length] + ' ' + i,
                        department: departments[i % departments.length],
                        designation: designations[i % designations.length],
                        bankAccount: `${Math.floor(Math.random() * 9000000000) + 1000000000}`,
                        ifsc: 'SBIN0001234',
                        basicSalary: Math.floor(Math.random() * 50000) + 20000,
                        hra: 0,
                        conveyance: 0,
                        otherAllowances: 0,
                        status: i <= 69 ? 'Active' : 'Inactive',
                        uan: `${Math.floor(Math.random() * 900000000000) + 100000000000}`,
                        esicNumber: `${Math.floor(Math.random() * 9000000000) + 1000000000}`,
                        advance: i % 10 === 0 ? Math.floor(Math.random() * 5000) + 1000 : 0
                    });
                }
            }

            // Initialize attendance for current month
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
                employees.forEach(emp => {
                    if (emp.status === 'Active') {
                        attendance[currentMonth][emp.id] = generateMonthlyAttendance();
                    }
                });
            }
        }

        function generateMonthlyAttendance() {
            // Get the correct number of days in the month
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]);
            const days = new Date(year, month, 0).getDate(); // This gives the last day of the month
            const monthAttendance = [];
            
            for (let day = 1; day <= days; day++) {
                const date = new Date(year, month - 1, day); // month is 0-indexed in JS
                const dayOfWeek = date.getDay();
                
                if (dayOfWeek === 0) { // Sunday
                    monthAttendance.push('Off');
                } else {
                    const rand = Math.random();
                    if (rand < 0.85) monthAttendance.push('P');
                    else if (rand < 0.90) monthAttendance.push('A');
                    else if (rand < 0.95) monthAttendance.push('OT');
                    else monthAttendance.push('POT');
                }
            }
            
            return monthAttendance;
        }

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Update data based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'employees') {
                displayEmployees();
            } else if (tabName === 'attendance') {
                displayAttendance();
            } else if (tabName === 'payroll') {
                displayPayroll();
            }
            
            addActivity(`Switched to ${tabName} tab`);
        }

        // Dashboard Functions
        function updateDashboard() {
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            document.getElementById('total-employees').textContent = employees.length;
            
            // Calculate payroll if not already done
            if (payrollData.length === 0) {
                processPayroll(false);
            }
            
            const grossTotal = payrollData.reduce((sum, emp) => sum + (emp.grossSalary || 0), 0);
            const netTotal = payrollData.reduce((sum, emp) => sum + (emp.netPay || 0), 0);
            const deductionsTotal = payrollData.reduce((sum, emp) => sum + (emp.totalDeductions || 0), 0);
            
            document.getElementById('gross-payroll').textContent = '₹' + grossTotal.toLocaleString('en-IN');
            document.getElementById('total-net-pay').textContent = '₹' + netTotal.toLocaleString('en-IN');
            document.getElementById('total-deductions').textContent = '₹' + deductionsTotal.toLocaleString('en-IN');
            document.getElementById('deduction-percentage').textContent = 
                grossTotal > 0 ? ((deductionsTotal / grossTotal) * 100).toFixed(1) + '%' : '0%';
            
            // Update progress bar
            const progressBar = document.getElementById('payroll-progress');
            if (progressBar) {
                progressBar.style.width = payrollData.length > 0 ? '100%' : '0%';
            }
            
            // Update recent activities
            updateRecentActivities();
            
            // Update charts
            updateCharts();
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            container.innerHTML = '';
            
            const recentActivities = activities.slice(-5).reverse();
            recentActivities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-circle text-blue-500 text-xs"></i>
                        <span class="text-sm text-gray-700 dark:text-gray-300">${activity.message}</span>
                    </div>
                    <span class="text-xs text-gray-500">${formatTime(activity.timestamp)}</span>
                `;
                container.appendChild(div);
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';
            return date.toLocaleDateString();
        }

        function addActivity(message) {
            activities.push({
                message: message,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 activities
            if (activities.length > 50) {
                activities = activities.slice(-50);
            }
            
            updateRecentActivities();
        }

        // Chart Functions
        function initializeCharts() {
            // Department Distribution Chart
            const deptCtx = document.getElementById('departmentChart');
            if (deptCtx) {
                const deptData = getDepartmentData();
                new Chart(deptCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(deptData),
                        datasets: [{
                            data: Object.values(deptData),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Salary Range Chart
            const salaryCtx = document.getElementById('salaryRangeChart');
            if (salaryCtx) {
                const salaryData = getSalaryRangeData();
                new Chart(salaryCtx, {
                    type: 'bar',
                    data: {
                        labels: salaryData.labels,
                        datasets: [{
                            label: 'Employees',
                            data: salaryData.data,
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateCharts() {
            // Update chart data if needed
        }

        function getDepartmentData() {
            const deptCount = {};
            employees.forEach(emp => {
                if (emp.status === 'Active') {
                    deptCount[emp.department] = (deptCount[emp.department] || 0) + 1;
                }
            });
            return deptCount;
        }

        function getSalaryRangeData() {
            const ranges = {
                '< 20K': 0,
                '20K-40K': 0,
                '40K-60K': 0,
                '60K-80K': 0,
                '> 80K': 0
            };
            
            employees.forEach(emp => {
                if (emp.status === 'Active') {
                    const salary = emp.basicSalary;
                    if (salary < 20000) ranges['< 20K']++;
                    else if (salary < 40000) ranges['20K-40K']++;
                    else if (salary < 60000) ranges['40K-60K']++;
                    else if (salary < 80000) ranges['60K-80K']++;
                    else ranges['> 80K']++;
                }
            });
            
            return {
                labels: Object.keys(ranges),
                data: Object.values(ranges)
            };
        }

        // Employee Management Functions
        function displayEmployees() {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';
            
            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="font-semibold">${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.designation}</td>
                    <td>${emp.bankAccount}</td>
                    <td>${emp.ifsc}</td>
                    <td>₹${emp.basicSalary.toLocaleString('en-IN')}</td>
                    <td>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                            emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${emp.status}
                        </span>
                    </td>
                    <td>
                        <button onclick="editEmployee('${emp.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#employeeTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function sortEmployees(field) {
            employees.sort((a, b) => {
                if (field === 'id' || field === 'name') {
                    return a[field].localeCompare(b[field]);
                }
                return a[field] - b[field];
            });
            displayEmployees();
        }

        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function addEmployee(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newEmployee = {
                id: formData.get('id'),
                name: formData.get('name'),
                department: formData.get('department'),
                designation: formData.get('designation'),
                bankAccount: formData.get('bankAccount'),
                ifsc: formData.get('ifsc'),
                basicSalary: parseInt(formData.get('basicSalary')),
                hra: 0,
                conveyance: 0,
                otherAllowances: 0,
                status: formData.get('status'),
                uan: Math.floor(Math.random() * 900000000000) + 100000000000,
                esicNumber: Math.floor(Math.random() * 9000000000) + 1000000000,
                advance: 0
            };
            
            employees.push(newEmployee);
            closeModal('addEmployeeModal');
            displayEmployees();
            event.target.reset();
            
            Swal.fire({
                icon: 'success',
                title: 'Employee Added',
                text: `${newEmployee.name} has been added successfully.`,
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity(`Added new employee: ${newEmployee.name}`);
            saveToLocalStorage();
        }

        function editEmployee(empId) {
            const employee = employees.find(emp => emp.id === empId);
            if (employee) {
                // Implement edit functionality
                Swal.fire({
                    title: 'Edit Employee',
                    text: 'Edit functionality coming soon!',
                    icon: 'info'
                });
            }
        }

        function deleteEmployee(empId) {
            Swal.fire({
                title: 'Delete Employee?',
                text: "This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete!'
            }).then((result) => {
                if (result.isConfirmed) {
                    employees = employees.filter(emp => emp.id !== empId);
                    displayEmployees();
                    updateDashboard();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Employee has been deleted.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    addActivity(`Deleted employee: ${empId}`);
                    saveToLocalStorage();
                }
            });
        }

        // Attendance Functions
        function displayAttendance() {
            const tbody = document.getElementById('attendanceTableBody');
            const thead = tbody.parentElement.querySelector('thead');
            tbody.innerHTML = '';
            
            // Get the correct number of days in the month
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Create the header row with day numbers
            thead.innerHTML = `
                <tr>
                    <th class="sticky left-0 bg-gradient-to-r from-purple-600 to-blue-600 z-10">Employee</th>
                    ${Array.from({length: daysInMonth}, (_, i) => 
                        `<th class="min-w-[40px] text-center">${i + 1}</th>`
                    ).join('')}
                    <th class="sticky right-0 bg-gradient-to-r from-purple-600 to-blue-600 z-10">Total</th>
                </tr>
            `;
            
            employees.forEach(emp => {
                if (emp.status === 'Active') {
                    const row = document.createElement('tr');
                    row.setAttribute('data-employee-id', emp.id); // Add this for search functionality
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors';
                    
                    // Employee name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'font-semibold text-left sticky left-0 bg-white dark:bg-gray-700 z-10 border-r border-gray-300';
                    nameCell.style.minWidth = '150px';
                    nameCell.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold">${emp.name}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${emp.id} - ${emp.department}</span>
                        </div>
                    `;
                    row.appendChild(nameCell);
                    
                    const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                    let totalPresent = 0;
                    
                    // Create attendance cells for each day
                    for (let day = 1; day <= daysInMonth; day++) {
                        const status = monthAttendance[day - 1] || '';
                        const cell = document.createElement('td');
                        cell.className = 'p-1 text-center';
                        
                        const button = document.createElement('button');
                        button.className = `attendance-cell ${status ? 'attendance-' + status : 'bg-gray-100 dark:bg-gray-600 text-gray-400'}`;
                        button.textContent = status || '-';
                        button.title = `Day ${day} - Click to change`;
                        button.onclick = () => toggleAttendance(emp.id, day - 1);
                        
                        // Calculate total present days
                        if (status === 'P' || status === 'POT') totalPresent++;
                        if (status === 'OT') totalPresent += 0.5;
                        
                        cell.appendChild(button);
                        row.appendChild(cell);
                    }
                    
                    // Total cell
                    const totalCell = document.createElement('td');
                    totalCell.className = 'font-bold text-center sticky right-0 bg-white dark:bg-gray-700 z-10 border-l border-gray-300';
                    totalCell.textContent = totalPresent;
                    row.appendChild(totalCell);
                    
                    tbody.appendChild(row);
                }
            });
        }

        function toggleAttendance(empId, dayIndex) {
            const statuses = ['P', 'A', 'Off', 'OT', 'POT'];
            
            // Ensure attendance structure exists
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
            }
            if (!attendance[currentMonth][empId]) {
                attendance[currentMonth][empId] = generateMonthlyAttendance();
            }
            
            const currentStatus = attendance[currentMonth][empId][dayIndex] || '';
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % statuses.length;
            
            attendance[currentMonth][empId][dayIndex] = statuses[nextIndex];
            displayAttendance();
            saveToLocalStorage();
        }

        function bulkMarkAttendance(status) {
            Swal.fire({
                title: 'Mark All as ' + status + '?',
                text: "This will update all active employees' attendance for the current month.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, update all!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Get the correct number of days in the month
                    const year = parseInt(currentMonth.split('-')[0]);
                    const month = parseInt(currentMonth.split('-')[1]);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    
                    // Initialize attendance for current month if not exists
                    if (!attendance[currentMonth]) {
                        attendance[currentMonth] = {};
                    }
                    
                    let updatedCount = 0;
                    
                    employees.forEach(emp => {
                        if (emp.status === 'Active') {
                            // Initialize attendance array if not exists
                            if (!attendance[currentMonth][emp.id]) {
                                attendance[currentMonth][emp.id] = new Array(daysInMonth).fill('');
                            }
                            
                            // Update attendance for all days
                            for (let i = 0; i < daysInMonth; i++) {
                                const date = new Date(year, month - 1, i + 1); // month is 0-indexed in JS
                                
                                // Skip Sundays for 'P' status, but allow manual marking of other statuses
                                if (status === 'P' && date.getDay() === 0) {
                                    attendance[currentMonth][emp.id][i] = 'Off'; // Mark Sundays as Off
                                } else {
                                    attendance[currentMonth][emp.id][i] = status;
                                }
                            }
                            updatedCount++;
                        }
                    });
                    
                    displayAttendance();
                    Swal.fire({
                        icon: 'success',
                        title: 'Bulk Update Complete!',
                        text: `Updated attendance for ${updatedCount} employees.`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    addActivity(`Bulk updated attendance to '${status}' for ${updatedCount} employees`);
                    saveToLocalStorage();
                }
            });
        }

        function clearAllAttendance() {
            Swal.fire({
                title: 'Clear All Attendance?',
                text: "This will remove all attendance data for the current month. This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear all!',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Get the correct number of days in the month
                    const year = parseInt(currentMonth.split('-')[0]);
                    const month = parseInt(currentMonth.split('-')[1]);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    
                    // Initialize attendance for current month if not exists
                    if (!attendance[currentMonth]) {
                        attendance[currentMonth] = {};
                    }
                    
                    let clearedCount = 0;
                    
                    employees.forEach(emp => {
                        if (emp.status === 'Active') {
                            // Clear attendance array
                            attendance[currentMonth][emp.id] = new Array(daysInMonth).fill('');
                            clearedCount++;
                        }
                    });
                    
                    displayAttendance();
                    Swal.fire({
                        icon: 'success',
                        title: 'Attendance Cleared!',
                        text: `Cleared attendance for ${clearedCount} employees.`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    addActivity(`Cleared all attendance for ${clearedCount} employees`);
                    saveToLocalStorage();
                }
            });
        }

        function markTodayAttendance() {
            const today = new Date();
            const currentDate = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const monthPrefix = currentDate.substring(0, 7); // YYYY-MM
            
            // Check if today is in the selected month
            if (monthPrefix !== currentMonth) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Different Month Selected',
                    text: `Today is ${today.toLocaleDateString('en-IN')} but you have ${currentMonth} selected. Please select the current month first.`
                });
                return;
            }
            
            const dayOfMonth = today.getDate();
            const dayIndex = dayOfMonth - 1;
            
            Swal.fire({
                title: 'Mark Today\'s Attendance',
                text: `Mark attendance for ${today.toLocaleDateString('en-IN')} (Day ${dayOfMonth})`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Mark All Present',
                cancelButtonText: 'Cancel',
                showDenyButton: true,
                denyButtonText: 'Choose Status'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mark all as present for today
                    markDayAttendance(dayIndex, 'P');
                } else if (result.isDenied) {
                    // Show status selection
                    showDayStatusSelector(dayIndex, dayOfMonth);
                }
            });
        }

        function markDayAttendance(dayIndex, status) {
            // Initialize attendance for current month if not exists
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
            }
            
            let updatedCount = 0;
            
            employees.forEach(emp => {
                if (emp.status === 'Active') {
                    // Initialize attendance array if not exists
                    if (!attendance[currentMonth][emp.id]) {
                        const year = parseInt(currentMonth.split('-')[0]);
                        const month = parseInt(currentMonth.split('-')[1]);
                        const daysInMonth = new Date(year, month, 0).getDate();
                        attendance[currentMonth][emp.id] = new Array(daysInMonth).fill('');
                    }
                    
                    attendance[currentMonth][emp.id][dayIndex] = status;
                    updatedCount++;
                }
            });
            
            displayAttendance();
            Swal.fire({
                icon: 'success',
                title: 'Day Attendance Updated!',
                text: `Marked ${updatedCount} employees as '${status}' for day ${dayIndex + 1}.`,
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity(`Marked day ${dayIndex + 1} attendance as '${status}' for ${updatedCount} employees`);
            saveToLocalStorage();
        }

        function showDayStatusSelector(dayIndex, dayOfMonth) {
            Swal.fire({
                title: `Select Status for Day ${dayOfMonth}`,
                icon: 'question',
                showCancelButton: true,
                showDenyButton: true,
                showCloseButton: true,
                confirmButtonText: 'Present (P)',
                confirmButtonColor: '#22c55e',
                denyButtonText: 'Absent (A)',
                denyButtonColor: '#ef4444',
                cancelButtonText: 'Weekly Off',
                cancelButtonColor: '#8b5cf6',
                footer: '<button onclick="markDayAttendance(' + dayIndex + ', \'OT\')" class="swal2-styled" style="background-color: #f59e0b;">Overtime (OT)</button>'
            }).then((result) => {
                if (result.isConfirmed) {
                    markDayAttendance(dayIndex, 'P');
                } else if (result.isDenied) {
                    markDayAttendance(dayIndex, 'A');
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    markDayAttendance(dayIndex, 'Off');
                }
            });
        }

        function showDepartmentAttendance() {
            // Get unique departments
            const departments = [...new Set(employees.filter(emp => emp.status === 'Active').map(emp => emp.department))];
            
            if (departments.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Departments Found',
                    text: 'No active employees found in any department.'
                });
                return;
            }
            
            // Create department selection HTML
            const departmentOptions = departments.map(dept => 
                `<option value="${dept}">${dept}</option>`
            ).join('');
            
            Swal.fire({
                title: 'Department-wise Attendance',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Department:</label>
                            <select id="deptSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                ${departmentOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Status:</label>
                            <select id="statusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="P">Present (P)</option>
                                <option value="A">Absent (A)</option>
                                <option value="Off">Weekly Off</option>
                                <option value="OT">Overtime (OT)</option>
                                <option value="POT">Present + OT</option>
                            </select>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Mark All in Department',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const dept = document.getElementById('deptSelect').value;
                    const status = document.getElementById('statusSelect').value;
                    
                    if (!dept || !status) {
                        Swal.showValidationMessage('Please select both department and status');
                        return false;
                    }
                    
                    return { department: dept, status: status };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    markDepartmentAttendance(result.value.department, result.value.status);
                }
            });
        }

        function markDepartmentAttendance(department, status) {
            // Get the correct number of days in the month
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Initialize attendance for current month if not exists
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
            }
            
            let updatedCount = 0;
            
            employees.forEach(emp => {
                if (emp.status === 'Active' && emp.department === department) {
                    // Initialize attendance array if not exists
                    if (!attendance[currentMonth][emp.id]) {
                        attendance[currentMonth][emp.id] = new Array(daysInMonth).fill('');
                    }
                    
                    // Update attendance for all days
                    for (let i = 0; i < daysInMonth; i++) {
                        const date = new Date(year, month - 1, i + 1);
                        
                        // Skip Sundays for 'P' status, but allow manual marking of other statuses
                        if (status === 'P' && date.getDay() === 0) {
                            attendance[currentMonth][emp.id][i] = 'Off'; // Mark Sundays as Off
                        } else {
                            attendance[currentMonth][emp.id][i] = status;
                        }
                    }
                    updatedCount++;
                }
            });
            
            displayAttendance();
            Swal.fire({
                icon: 'success',
                title: 'Department Attendance Updated!',
                text: `Updated attendance for ${updatedCount} employees in ${department} department.`,
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity(`Bulk updated ${department} department attendance to '${status}' for ${updatedCount} employees`);
            saveToLocalStorage();
        }

        function importAttendance() {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            input.onchange = handleAttendanceImport;
            input.click();
        }

        function handleAttendanceImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Swal.fire({
                title: 'Importing...',
                text: 'Please wait while we process your file.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Simulate import (in real app, would parse the file)
            setTimeout(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Import Complete!',
                    text: 'Attendance data has been imported successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                addActivity('Imported attendance from file');
            }, 2000);
        }

        // Payroll Functions
        function processPayroll(showNotification = true) {
            payrollData = [];
            
            employees.forEach(emp => {
                if (emp.status === 'Active') {
                    const payroll = calculateEmployeePayroll(emp);
                    payrollData.push(payroll);
                }
            });
            
            displayPayroll();
            updateDashboard();
            
            if (showNotification) {
                Swal.fire({
                    icon: 'success',
                    title: 'Payroll Processed!',
                    text: `Payroll calculated for ${payrollData.length} employees.`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                addActivity('Processed payroll for ' + currentMonth);
            }
            
            saveToLocalStorage();
        }

        function calculateEmployeePayroll(employee) {
            const monthAttendance = attendance[currentMonth]?.[employee.id] || [];
            let workingDays = 0;
            let overtimeDays = 0;
            
            monthAttendance.forEach(status => {
                if (status === 'P') workingDays++;
                else if (status === 'POT') { workingDays++; overtimeDays++; }
                else if (status === 'OT') overtimeDays++;
            });
            
            // Get the correct number of days in the month
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]);
            const totalDays = new Date(year, month, 0).getDate();
            const dailyRate = employee.basicSalary / totalDays;
            
            // Calculate components
            const basic = Math.round(dailyRate * workingDays);
            const hra = Math.round(basic * 0.4); // 40% of basic
            const conveyance = workingDays > 0 ? 1600 : 0;
            const otherAllowances = workingDays > 0 ? 2000 : 0;
            const overtimeAmount = Math.round(overtimeDays * dailyRate * 1.5);
            
            const grossSalary = basic + hra + conveyance + otherAllowances + overtimeAmount;
            
            // Calculate deductions
            const pfBase = Math.min(basic, 15000);
            const pf = Math.round(pfBase * 0.12);
            
            const esicBase = grossSalary <= 21000 ? grossSalary : 0;
            const esic = Math.round(esicBase * 0.0075);
            
            const pt = grossSalary > 10000 ? 200 : 0;
            const advance = employee.advance || 0;
            
            const totalDeductions = pf + esic + pt;
            const netPayBeforeAdvance = grossSalary - totalDeductions;
            const netPay = netPayBeforeAdvance - advance;
            
            return {
                ...employee,
                workingDays,
                overtimeDays,
                basic,
                hra,
                conveyance,
                otherAllowances,
                overtimeAmount,
                grossSalary,
                pf,
                esic,
                pt,
                advance,
                totalDeductions,
                netPayBeforeAdvance,
                netPay
            };
        }

        function displayPayroll() {
            const tbody = document.getElementById('payrollTableBody');
            tbody.innerHTML = '';
            
            payrollData.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="text-left">${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.workingDays}</td>
                    <td>₹${emp.basic.toLocaleString('en-IN')}</td>
                    <td>₹${emp.hra.toLocaleString('en-IN')}</td>
                    <td>₹${emp.conveyance.toLocaleString('en-IN')}</td>
                    <td>₹${emp.otherAllowances.toLocaleString('en-IN')}</td>
                    <td>₹${emp.overtimeAmount.toLocaleString('en-IN')}</td>
                    <td class="font-bold">₹${emp.grossSalary.toLocaleString('en-IN')}</td>
                    <td>₹${emp.pf.toLocaleString('en-IN')}</td>
                    <td>₹${emp.esic.toLocaleString('en-IN')}</td>
                    <td>₹${emp.pt.toLocaleString('en-IN')}</td>
                    <td><input type="number" class="advance-input w-full px-2 py-1 text-center border border-gray-300 rounded" value="${emp.advance}" min="0" onchange="updateAdvance(${emp.id}, this.value)" /></td>
                    <td class="font-bold">₹${emp.totalDeductions.toLocaleString('en-IN')}</td>
                    <td class="font-bold text-green-600">₹${emp.netPay.toLocaleString('en-IN')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update advance amount for a specific employee
        function updateAdvance(empId, newAdvance) {
            const advanceAmount = parseFloat(newAdvance) || 0;
            
            // Find and update the employee in the employees array
            const employee = employees.find(emp => emp.id === empId);
            if (employee) {
                employee.advance = advanceAmount;
                
                // Recalculate payroll for this employee
                const updatedPayrollEntry = calculateEmployeePayroll(employee);
                
                // Update the payrollData array
                const payrollIndex = payrollData.findIndex(emp => emp.id === empId);
                if (payrollIndex !== -1) {
                    payrollData[payrollIndex] = updatedPayrollEntry;
                }
                
                // Update only the affected row for better performance
                updatePayrollRow(empId, updatedPayrollEntry);
                
                // Update dashboard totals
                updateDashboard();
                
                // Save to localStorage
                saveToLocalStorage();
                
                // Add activity log
                addActivity(`Updated advance for ${employee.name}: ₹${advanceAmount.toLocaleString('en-IN')}`);
            }
        }

        // Update a specific payroll row without refreshing entire table
        function updatePayrollRow(empId, updatedEmployee) {
            const tbody = document.getElementById('payrollTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            for (let row of rows) {
                const firstCell = row.querySelector('td');
                if (firstCell && firstCell.textContent === empId.toString()) {
                    // Update the row with new data
                    row.innerHTML = `
                        <td>${updatedEmployee.id}</td>
                        <td class="text-left">${updatedEmployee.name}</td>
                        <td>${updatedEmployee.department}</td>
                        <td>${updatedEmployee.workingDays}</td>
                        <td>₹${updatedEmployee.basic.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.hra.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.conveyance.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.otherAllowances.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.overtimeAmount.toLocaleString('en-IN')}</td>
                        <td class="font-bold">₹${updatedEmployee.grossSalary.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.pf.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.esic.toLocaleString('en-IN')}</td>
                        <td>₹${updatedEmployee.pt.toLocaleString('en-IN')}</td>
                        <td><input type="number" class="advance-input w-full px-2 py-1 text-center border border-gray-300 rounded" value="${updatedEmployee.advance}" min="0" onchange="updateAdvance(${updatedEmployee.id}, this.value)" /></td>
                        <td class="font-bold">₹${updatedEmployee.totalDeductions.toLocaleString('en-IN')}</td>
                        <td class="font-bold text-green-600">₹${updatedEmployee.netPay.toLocaleString('en-IN')}</td>
                    `;
                    break;
                }
            }
        }

        // Export Functions
        function exportPayroll() {
            const wb = XLSX.utils.book_new();
            
            // Payroll sheet
            const payrollSheet = XLSX.utils.json_to_sheet(payrollData.map(emp => ({
                'Employee ID': emp.id,
                'Name': emp.name,
                'Department': emp.department,
                'Working Days': emp.workingDays,
                'Basic': emp.basic,
                'HRA': emp.hra,
                'Conveyance': emp.conveyance,
                'Other Allowances': emp.otherAllowances,
                'Overtime': emp.overtimeAmount,
                'Gross Salary': emp.grossSalary,
                'PF': emp.pf,
                'ESIC': emp.esic,
                'PT': emp.pt,
                'Advance': emp.advance,
                'Total Deductions': emp.totalDeductions,
                'Net Pay': emp.netPay
            })));
            
            XLSX.utils.book_append_sheet(wb, payrollSheet, 'Payroll');
            
            // Download
            XLSX.writeFile(wb, `Payroll_${currentMonth}.xlsx`);
            
            addActivity('Exported payroll to Excel');
        }

        function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // Employee Master
            const empSheet = XLSX.utils.json_to_sheet(employees);
            XLSX.utils.book_append_sheet(wb, empSheet, 'Employees');
            
            // Attendance
            const attendanceData = [];
            employees.forEach(emp => {
                if (attendance[currentMonth]?.[emp.id]) {
                    const row = { 'Employee': emp.name };
                    attendance[currentMonth][emp.id].forEach((status, index) => {
                        row[`Day ${index + 1}`] = status;
                    });
                    attendanceData.push(row);
                }
            });
            const attSheet = XLSX.utils.json_to_sheet(attendanceData);
            XLSX.utils.book_append_sheet(wb, attSheet, 'Attendance');
            
            // Payroll
            if (payrollData.length > 0) {
                const paySheet = XLSX.utils.json_to_sheet(payrollData);
                XLSX.utils.book_append_sheet(wb, paySheet, 'Payroll');
            }
            
            // Download
            XLSX.writeFile(wb, `Hospital_Payroll_Complete_${currentMonth}.xlsx`);
            
            Swal.fire({
                icon: 'success',
                title: 'Export Complete!',
                text: 'All data has been exported successfully.',
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity('Exported all data to Excel');
        }

        // Report Generation Functions
        function showPayslipSelector() {
            const modal = document.getElementById('payslipModal');
            const list = document.getElementById('payslipEmployeeList');
            
            list.innerHTML = '';
            payrollData.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                div.innerHTML = `
                    <input type="checkbox" id="payslip-${emp.id}" value="${emp.id}" class="mr-3">
                    <label for="payslip-${emp.id}" class="flex-1 cursor-pointer">
                        <span class="font-semibold">${emp.name}</span> - ${emp.department}
                        <span class="float-right text-green-600 font-bold">₹${emp.netPay.toLocaleString('en-IN')}</span>
                    </label>
                `;
                list.appendChild(div);
            });
            
            modal.classList.remove('hidden');
        }

        function filterPayslipEmployees() {
            const searchTerm = document.getElementById('payslipSearch').value.toLowerCase();
            const items = document.querySelectorAll('#payslipEmployeeList > div');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function selectAllPayslips(select) {
            const checkboxes = document.querySelectorAll('#payslipEmployeeList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function generateSelectedPayslips() {
            const selected = Array.from(document.querySelectorAll('#payslipEmployeeList input:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Selection',
                    text: 'Please select at least one employee.'
                });
                return;
            }
            
            closeModal('payslipModal');
            
            // Generate payslips
            selected.forEach(empId => {
                const employee = payrollData.find(emp => emp.id === empId);
                if (employee) {
                    generatePayslip(employee);
                }
            });
            
            Swal.fire({
                icon: 'success',
                title: 'Payslips Generated!',
                text: `Generated ${selected.length} payslips.`,
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity(`Generated ${selected.length} payslips`);
        }

        function generatePayslip(employee) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Professional MNC-style color scheme
            const primaryColor = [41, 128, 185];  // Professional blue
            const secondaryColor = [52, 73, 94];  // Dark grey
            const accentColor = [230, 126, 34];   // Orange accent
            const lightGrey = [245, 245, 245];
            
            // Header Section - Professional Design
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 45, 'F');
            
            // Company Logo Area (placeholder)
            doc.setFillColor(255, 255, 255);
            doc.rect(15, 8, 30, 30, 'F');
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('LOGO', 30, 25, { align: 'center' });
            
            // Company Header
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Corporate Office: Medical Plaza, Healthcare District', 105, 28, { align: 'center' });
            doc.text('Email: hr@shishuraksha.com | Phone: +91-11-2345-6789', 105, 35, { align: 'center' });
            
            // Document Title Bar
            doc.setFillColor(...secondaryColor);
            doc.rect(0, 45, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SALARY SLIP', 20, 55);
            
            // Format month for display
            const monthName = new Date(currentMonth + '-01').toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            doc.text(`Pay Period: ${monthName}`, 190, 55, { align: 'right' });
            
            // Reset text color for content
            doc.setTextColor(0, 0, 0);
            
            // Employee Information Section
            doc.setFillColor(...lightGrey);
            doc.rect(15, 70, 180, 45, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, 70, 180, 45);
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...secondaryColor);
            doc.text('EMPLOYEE INFORMATION', 20, 82);
            
            // Employee details in two columns
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            const leftColumn = [
                ['Employee ID:', employee.id],
                ['Name:', employee.name],
                ['Department:', employee.department],
                ['Designation:', employee.designation]
            ];
            
            const rightColumn = [
                ['Bank Account:', employee.bankAccount],
                ['IFSC Code:', employee.ifsc || 'SBIN0001234'],
                ['Working Days:', `${employee.workingDays}/30`],
                ['Payment Date:', new Date().toLocaleDateString('en-IN')]
            ];
            
            let y = 92;
            leftColumn.forEach(([label, value]) => {
                doc.setFont('helvetica', 'bold');
                doc.text(label, 25, y);
                doc.setFont('helvetica', 'normal');
                doc.text(value, 70, y);
                y += 7;
            });
            
            y = 92;
            rightColumn.forEach(([label, value]) => {
                doc.setFont('helvetica', 'bold');
                doc.text(label, 115, y);
                doc.setFont('helvetica', 'normal');
                doc.text(value, 160, y);
                y += 7;
            });
            
            // Earnings and Deductions Table
            const tableStartY = 130;
            
            // Table Header
            doc.setFillColor(...primaryColor);
            doc.rect(15, tableStartY, 180, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('EARNINGS', 60, tableStartY + 8, { align: 'center' });
            doc.text('DEDUCTIONS', 150, tableStartY + 8, { align: 'center' });
            
            // Table content background
            doc.setFillColor(255, 255, 255);
            doc.rect(15, tableStartY + 12, 180, 80, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, tableStartY, 180, 92);
            
            // Vertical divider
            doc.line(105, tableStartY, 105, tableStartY + 92);
            
            // Earnings Section
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            const earningsData = [
                ['Basic Salary', employee.basic],
                ['House Rent Allowance', employee.hra],
                ['Conveyance Allowance', employee.conveyance],
                ['Other Allowances', employee.otherAllowances],
                ['Overtime Amount', employee.overtimeAmount]
            ];
            
            let earningsY = tableStartY + 22;
            let totalEarnings = 0;
            
            earningsData.forEach(([label, amount]) => {
                totalEarnings += amount;
                doc.text(label, 20, earningsY);
                doc.text(`₹${amount.toLocaleString('en-IN')}`, 100, earningsY, { align: 'right' });
                earningsY += 10;
            });
            
            // Deductions Section
            const deductionsData = [
                ['Provident Fund (PF)', employee.pf],
                ['Employee State Insurance', employee.esic],
                ['Professional Tax', employee.pt],
                ['Advance Recovery', employee.advance],
                ['Income Tax (TDS)', 0] // Placeholder for future use
            ];
            
            let deductionsY = tableStartY + 22;
            let totalDeductions = 0;
            
            deductionsData.forEach(([label, amount]) => {
                totalDeductions += amount;
                doc.text(label, 110, deductionsY);
                doc.text(`₹${amount.toLocaleString('en-IN')}`, 190, deductionsY, { align: 'right' });
                deductionsY += 10;
            });
            
            // Totals Row
            doc.setFillColor(...lightGrey);
            doc.rect(15, tableStartY + 72, 180, 10, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL EARNINGS', 20, tableStartY + 79);
            doc.text(`₹${employee.grossSalary.toLocaleString('en-IN')}`, 100, tableStartY + 79, { align: 'right' });
            doc.text('TOTAL DEDUCTIONS', 110, tableStartY + 79);
            doc.text(`₹${employee.totalDeductions.toLocaleString('en-IN')}`, 190, tableStartY + 79, { align: 'right' });
            
            // Net Pay Section - Highlighted
            doc.setFillColor(...accentColor);
            doc.rect(15, tableStartY + 92, 180, 18, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('NET PAY', 30, tableStartY + 103);
            doc.text(`₹${employee.netPay.toLocaleString('en-IN')}`, 180, tableStartY + 103, { align: 'right' });
            
            // Net Pay in Words
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            const netPayInWords = numberToWords(employee.netPay);
            doc.text(`Amount in Words: ${netPayInWords} Rupees Only`, 30, tableStartY + 120);
            
            // Professional Footer
            doc.setDrawColor(...primaryColor);
            doc.line(15, 250, 195, 250);
            
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('CONFIDENTIAL DOCUMENT', 20, 260);
            doc.text('This payslip is computer generated and does not require signature.', 20, 268);
            doc.text('For any queries, please contact HR Department at hr@shishuraksha.com', 20, 276);
            
            // Document metadata
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN')} ${new Date().toLocaleTimeString('en-IN')}`, 190, 260, { align: 'right' });
            doc.text('Document ID: PAY' + employee.id + currentMonth.replace('-', ''), 190, 268, { align: 'right' });
            
            // Company stamp area
            doc.setDrawColor(200, 200, 200);
            doc.rect(140, 220, 50, 25);
            doc.setFontSize(7);
            doc.text('AUTHORIZED SIGNATORY', 165, 245, { align: 'center' });
            
            // Save with professional filename
            const monthYear = currentMonth.replace('-', '_');
            doc.save(`Payslip_${employee.name.replace(/\s+/g, '_')}_${monthYear}.pdf`);
        }
        
        // Helper function to convert numbers to words (basic implementation)
        function numberToWords(amount) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            if (amount === 0) return 'Zero';
            if (amount < 10) return ones[amount];
            if (amount < 20) return teens[amount - 10];
            if (amount < 100) return tens[Math.floor(amount / 10)] + (amount % 10 ? ' ' + ones[amount % 10] : '');
            if (amount < 1000) return ones[Math.floor(amount / 100)] + ' Hundred' + (amount % 100 ? ' ' + numberToWords(amount % 100) : '');
            if (amount < 100000) return numberToWords(Math.floor(amount / 1000)) + ' Thousand' + (amount % 1000 ? ' ' + numberToWords(amount % 1000) : '');
            if (amount < 10000000) return numberToWords(Math.floor(amount / 100000)) + ' Lakh' + (amount % 100000 ? ' ' + numberToWords(amount % 100000) : '');
            
            return 'Amount too large';
        }

        function generateBankStatement() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Professional styling
            const primaryColor = [41, 128, 185];
            const secondaryColor = [52, 73, 94];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('BANK PAYMENT STATEMENT', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Shishuraksha Children\'s Hospital', 105, 30, { align: 'center' });
            
            // Document info
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(11);
            const monthName = new Date(currentMonth + '-01').toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            doc.text(`Pay Period: ${monthName}`, 20, 55);
            doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 190, 55, { align: 'right' });
            
            // Table data with professional formatting
            const tableData = payrollData.map((emp, index) => [
                (index + 1).toString(),
                emp.name,
                emp.bankAccount,
                emp.ifsc || 'SBIN0001234',
                '₹' + emp.netPay.toLocaleString('en-IN'),
                'NEFT'
            ]);
            
            const totalAmount = payrollData.reduce((sum, emp) => sum + emp.netPay, 0);
            
            // Add summary row
            tableData.push([
                '',
                'TOTAL PAYMENT',
                '',
                '',
                '₹' + totalAmount.toLocaleString('en-IN'),
                ''
            ]);
            
            doc.autoTable({
                head: [['S.No', 'Employee Name', 'Account Number', 'IFSC Code', 'Amount', 'Mode']],
                body: tableData,
                startY: 65,
                styles: { 
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: { 
                    fillColor: primaryColor,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                footStyles: {
                    fillColor: [230, 126, 34],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                }
            });
            
            // Summary box
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFillColor(245, 245, 245);
            doc.rect(120, finalY, 70, 30, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(120, finalY, 70, 30);
            
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('PAYMENT SUMMARY', 155, finalY + 8, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Employees: ${payrollData.length}`, 125, finalY + 18);
            doc.text(`Total Amount: ₹${totalAmount.toLocaleString('en-IN')}`, 125, finalY + 25);
            
            // Footer
            doc.setFontSize(8);
            doc.text('This is a computer generated document for bank transfer purposes.', 105, 280, { align: 'center' });
            
            doc.save(`Bank_Payment_Statement_${currentMonth.replace('-', '_')}.pdf`);
            
            addActivity('Generated bank payment statement');
        }

        function generateGovernmentFiles() {
            // Generate PF file
            generatePFFile();
            
            // Generate ESIC file
            generateESICFile();
            
            // Generate PT file
            generatePTFile();
            
            Swal.fire({
                icon: 'success',
                title: 'Files Generated!',
                text: 'PF, ESIC, and PT files have been generated.',
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity('Generated government compliance files');
        }

        function generatePFFile() {
            const pfData = payrollData.filter(emp => emp.pf > 0).map(emp => ({
                'UAN': emp.uan || 'N/A',
                'Employee Name': emp.name,
                'Gross Wages': emp.grossSalary,
                'EPF Wages': Math.min(emp.basic, 15000),
                'Employee Share': emp.pf,
                'Employer Share': emp.pf,
                'EPS Contribution': Math.round(Math.min(emp.basic, 15000) * 0.0833)
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(pfData);
            XLSX.utils.book_append_sheet(wb, ws, 'PF_Data');
            XLSX.writeFile(wb, `PF_Return_${currentMonth}.xlsx`);
        }

        function generateESICFile() {
            const esicData = payrollData.filter(emp => emp.esic > 0).map(emp => ({
                'IP Number': emp.esicNumber || 'N/A',
                'Employee Name': emp.name,
                'Gross Wages': emp.grossSalary,
                'Working Days': emp.workingDays,
                'Employee Contribution': emp.esic,
                'Employer Contribution': Math.round(emp.grossSalary * 0.0325)
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(esicData);
            XLSX.utils.book_append_sheet(wb, ws, 'ESIC_Data');
            XLSX.writeFile(wb, `ESIC_Return_${currentMonth}.xlsx`);
        }

        function generatePTFile() {
            const ptData = payrollData.filter(emp => emp.pt > 0).map(emp => ({
                'Employee ID': emp.id,
                'Employee Name': emp.name,
                'Gross Salary': emp.grossSalary,
                'PT Amount': emp.pt
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(ptData);
            XLSX.utils.book_append_sheet(wb, ws, 'PT_Data');
            XLSX.writeFile(wb, `PT_Return_${currentMonth}.xlsx`);
        }

        function generateDepartmentReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Professional styling
            const primaryColor = [41, 128, 185];
            const secondaryColor = [52, 73, 94];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('DEPARTMENT-WISE PAYROLL SUMMARY', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Shishuraksha Children\'s Hospital', 105, 30, { align: 'center' });
            
            // Document info
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(11);
            const monthName = new Date(currentMonth + '-01').toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            doc.text(`Report Period: ${monthName}`, 20, 55);
            doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 190, 55, { align: 'right' });
            
            // Calculate department-wise data
            const deptSummary = {};
            payrollData.forEach(emp => {
                if (!deptSummary[emp.department]) {
                    deptSummary[emp.department] = {
                        count: 0,
                        gross: 0,
                        deductions: 0,
                        net: 0,
                        avgSalary: 0
                    };
                }
                deptSummary[emp.department].count++;
                deptSummary[emp.department].gross += emp.grossSalary;
                deptSummary[emp.department].deductions += emp.totalDeductions;
                deptSummary[emp.department].net += emp.netPay;
            });
            
            // Calculate averages
            Object.keys(deptSummary).forEach(dept => {
                deptSummary[dept].avgSalary = Math.round(deptSummary[dept].gross / deptSummary[dept].count);
            });
            
            const tableData = Object.entries(deptSummary).map(([dept, data]) => [
                dept,
                data.count.toString(),
                '₹' + data.gross.toLocaleString('en-IN'),
                '₹' + data.deductions.toLocaleString('en-IN'),
                '₹' + data.net.toLocaleString('en-IN'),
                '₹' + data.avgSalary.toLocaleString('en-IN')
            ]);
            
            // Add totals row
            const totals = Object.values(deptSummary).reduce((acc, dept) => ({
                count: acc.count + dept.count,
                gross: acc.gross + dept.gross,
                deductions: acc.deductions + dept.deductions,
                net: acc.net + dept.net
            }), { count: 0, gross: 0, deductions: 0, net: 0 });
            
            const avgOverall = Math.round(totals.gross / totals.count);
            
            tableData.push([
                'TOTAL',
                totals.count.toString(),
                '₹' + totals.gross.toLocaleString('en-IN'),
                '₹' + totals.deductions.toLocaleString('en-IN'),
                '₹' + totals.net.toLocaleString('en-IN'),
                '₹' + avgOverall.toLocaleString('en-IN')
            ]);
            
            doc.autoTable({
                head: [['Department', 'Employees', 'Gross Total', 'Deductions', 'Net Total', 'Avg. Salary']],
                body: tableData,
                startY: 65,
                styles: { 
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: { 
                    fillColor: primaryColor,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                footStyles: {
                    fillColor: [230, 126, 34],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                }
            });
            
            // Key metrics
            const finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...secondaryColor);
            doc.text('KEY METRICS', 20, finalY);
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total Departments: ${Object.keys(deptSummary).length}`, 20, finalY + 10);
            doc.text(`• Total Employees: ${totals.count}`, 20, finalY + 18);
            doc.text(`• Average Department Size: ${Math.round(totals.count / Object.keys(deptSummary).length)} employees`, 20, finalY + 26);
            doc.text(`• Overall Average Salary: ₹${avgOverall.toLocaleString('en-IN')}`, 20, finalY + 34);
            doc.text(`• Total Payroll Cost: ₹${totals.gross.toLocaleString('en-IN')}`, 20, finalY + 42);
            
            // Footer
            doc.setFontSize(8);
            doc.text('This is a confidential document for internal management purposes only.', 105, 280, { align: 'center' });
            
            doc.save(`Department_Payroll_Summary_${currentMonth.replace('-', '_')}.pdf`);
            
            addActivity('Generated department payroll summary');
        }

        function generateAttendanceReport() {
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = employees.filter(emp => emp.status === 'Active').map(emp => {
                const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                const summary = {
                    'Employee ID': emp.id,
                    'Name': emp.name,
                    'Department': emp.department,
                    'Present': monthAttendance.filter(s => s === 'P').length,
                    'Absent': monthAttendance.filter(s => s === 'A').length,
                    'Weekly Off': monthAttendance.filter(s => s === 'Off').length,
                    'Overtime': monthAttendance.filter(s => s === 'OT').length,
                    'Present + OT': monthAttendance.filter(s => s === 'POT').length,
                    'Total Working': 0
                };
                summary['Total Working'] = summary.Present + summary['Present + OT'] + (summary.Overtime * 0.5);
                return summary;
            });
            
            const ws = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance_Summary');
            
            // Detailed sheet
            const detailedData = [];
            employees.forEach(emp => {
                if (attendance[currentMonth]?.[emp.id]) {
                    const row = { 'Employee': emp.name };
                    attendance[currentMonth][emp.id].forEach((status, index) => {
                        row[`Day ${index + 1}`] = status;
                    });
                    detailedData.push(row);
                }
            });
            
            const detailWs = XLSX.utils.json_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(wb, detailWs, 'Detailed_Attendance');
            
            XLSX.writeFile(wb, `Attendance_Report_${currentMonth}.xlsx`);
            
            addActivity('Generated attendance report');
        }

        function generateComprehensiveReport() {
            const wb = XLSX.utils.book_new();
            
            // 1. Employee Master
            const empSheet = XLSX.utils.json_to_sheet(employees);
            XLSX.utils.book_append_sheet(wb, empSheet, 'Employee_Master');
            
            // 2. Attendance Summary
            const attendanceSummary = employees.filter(emp => emp.status === 'Active').map(emp => {
                const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                return {
                    'Employee ID': emp.id,
                    'Name': emp.name,
                    'Department': emp.department,
                    'Present Days': monthAttendance.filter(s => s === 'P' || s === 'POT').length,
                    'Absent Days': monthAttendance.filter(s => s === 'A').length,
                    'Overtime Days': monthAttendance.filter(s => s === 'OT' || s === 'POT').length
                };
            });
            const attSummarySheet = XLSX.utils.json_to_sheet(attendanceSummary);
            XLSX.utils.book_append_sheet(wb, attSummarySheet, 'Attendance_Summary');
            
            // 3. Payroll Details
            if (payrollData.length > 0) {
                const payrollSheet = XLSX.utils.json_to_sheet(payrollData);
                XLSX.utils.book_append_sheet(wb, payrollSheet, 'Payroll_Details');
            }
            
            // 4. Department Summary
            const deptSummary = {};
            payrollData.forEach(emp => {
                if (!deptSummary[emp.department]) {
                    deptSummary[emp.department] = {
                        'Department': emp.department,
                        'Employee Count': 0,
                        'Total Gross': 0,
                        'Total Deductions': 0,
                        'Total Net': 0
                    };
                }
                deptSummary[emp.department]['Employee Count']++;
                deptSummary[emp.department]['Total Gross'] += emp.grossSalary;
                deptSummary[emp.department]['Total Deductions'] += emp.totalDeductions;
                deptSummary[emp.department]['Total Net'] += emp.netPay;
            });
            const deptSheet = XLSX.utils.json_to_sheet(Object.values(deptSummary));
            XLSX.utils.book_append_sheet(wb, deptSheet, 'Department_Summary');
            
            // 5. Bank Details
            const bankData = payrollData.map(emp => ({
                'Employee ID': emp.id,
                'Name': emp.name,
                'Bank Account': emp.bankAccount,
                'IFSC': emp.ifsc,
                'Net Salary': emp.netPay
            }));
            const bankSheet = XLSX.utils.json_to_sheet(bankData);
            XLSX.utils.book_append_sheet(wb, bankSheet, 'Bank_Details');
            
            // 6. Compliance Data
            const complianceData = payrollData.map(emp => ({
                'Employee ID': emp.id,
                'Name': emp.name,
                'UAN': emp.uan || 'N/A',
                'ESIC Number': emp.esicNumber || 'N/A',
                'PF Amount': emp.pf,
                'ESIC Amount': emp.esic,
                'PT Amount': emp.pt
            }));
            const complianceSheet = XLSX.utils.json_to_sheet(complianceData);
            XLSX.utils.book_append_sheet(wb, complianceSheet, 'Compliance_Data');
            
            // Download
            XLSX.writeFile(wb, `Comprehensive_Payroll_Report_${currentMonth}.xlsx`);
            
            Swal.fire({
                icon: 'success',
                title: 'Master Report Generated!',
                text: 'Comprehensive report with all data has been generated.',
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity('Generated comprehensive report');
        }

        // PDF Report Generation Functions
        function generateBankStatement() {
            if (payrollData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Data',
                    text: 'Please process payroll first to generate bank statement.'
                });
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(40, 116, 240);
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.text('Bank Payment Statement', 105, 30, { align: 'center' });
            doc.text(`Month: ${new Date(currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`, 105, 40, { align: 'center' });

            // Bank summary
            const totalNetPay = payrollData.reduce((sum, emp) => sum + emp.netPay, 0);
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Total Amount to Transfer: ₹${totalNetPay.toLocaleString('en-IN')}`, 20, 60);
            doc.text(`Number of Employees: ${payrollData.length}`, 20, 70);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 80);

            // Table headers
            const tableData = payrollData.map(emp => [
                emp.id,
                emp.name,
                emp.bankAccount || 'N/A',
                emp.ifsc || 'N/A',
                `₹${emp.netPay.toLocaleString('en-IN')}`
            ]);

            doc.autoTable({
                head: [['Emp ID', 'Name', 'Account Number', 'IFSC Code', 'Amount']],
                body: tableData,
                startY: 90,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [37, 99, 235] }
            });

            // Footer
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(10);
            doc.text('This is a computer-generated document.', 105, finalY, { align: 'center' });

            doc.save(`Bank_Statement_${currentMonth}.pdf`);
            
            Swal.fire({
                icon: 'success',
                title: 'Bank Statement Generated!',
                text: 'Professional bank statement has been downloaded.',
                timer: 2000,
                showConfirmButton: false
            });

            addActivity('Generated bank statement PDF');
        }

        function generateDepartmentReport() {
            if (payrollData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Data',
                    text: 'Please process payroll first to generate department report.'
                });
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(40, 116, 240);
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.text('Department-wise Payroll Analysis', 105, 30, { align: 'center' });
            doc.text(`Month: ${new Date(currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`, 105, 40, { align: 'center' });

            // Calculate department summaries
            const deptSummary = {};
            payrollData.forEach(emp => {
                if (!deptSummary[emp.department]) {
                    deptSummary[emp.department] = {
                        count: 0,
                        totalGross: 0,
                        totalDeductions: 0,
                        totalNet: 0
                    };
                }
                deptSummary[emp.department].count++;
                deptSummary[emp.department].totalGross += emp.grossSalary;
                deptSummary[emp.department].totalDeductions += emp.totalDeductions;
                deptSummary[emp.department].totalNet += emp.netPay;
            });

            // Department summary table
            const deptTableData = Object.entries(deptSummary).map(([dept, stats]) => [
                dept,
                stats.count,
                `₹${stats.totalGross.toLocaleString('en-IN')}`,
                `₹${stats.totalDeductions.toLocaleString('en-IN')}`,
                `₹${stats.totalNet.toLocaleString('en-IN')}`,
                `₹${Math.round(stats.totalNet / stats.count).toLocaleString('en-IN')}`
            ]);

            doc.autoTable({
                head: [['Department', 'Employees', 'Gross Salary', 'Deductions', 'Net Salary', 'Avg. Salary']],
                body: deptTableData,
                startY: 60,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [139, 92, 246] }
            });

            // Employee breakdown by department
            let currentY = doc.lastAutoTable.finalY + 20;
            
            Object.entries(deptSummary).forEach(([dept, stats]) => {
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(139, 92, 246);
                doc.text(`${dept} Department Details`, 20, currentY);
                currentY += 10;

                const deptEmployees = payrollData.filter(emp => emp.department === dept);
                const empTableData = deptEmployees.map(emp => [
                    emp.id,
                    emp.name,
                    emp.designation,
                    `₹${emp.basicSalary.toLocaleString('en-IN')}`,
                    `₹${emp.netPay.toLocaleString('en-IN')}`
                ]);

                doc.autoTable({
                    head: [['ID', 'Name', 'Designation', 'Basic', 'Net Pay']],
                    body: empTableData,
                    startY: currentY,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [168, 162, 158] }
                });

                currentY = doc.lastAutoTable.finalY + 15;
            });

            doc.save(`Department_Report_${currentMonth}.pdf`);
            
            Swal.fire({
                icon: 'success',
                title: 'Department Report Generated!',
                text: 'Comprehensive department analysis has been downloaded.',
                timer: 2000,
                showConfirmButton: false
            });

            addActivity('Generated department report PDF');
        }

        function generateAttendanceReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(40, 116, 240);
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.text('Monthly Attendance Report', 105, 30, { align: 'center' });
            doc.text(`Month: ${new Date(currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`, 105, 40, { align: 'center' });

            // Attendance summary
            const attendanceSummary = employees.filter(emp => emp.status === 'Active').map(emp => {
                const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                const presentDays = monthAttendance.filter(s => s === 'P').length;
                const absentDays = monthAttendance.filter(s => s === 'A').length;
                const offDays = monthAttendance.filter(s => s === 'Off').length;
                const overtimeDays = monthAttendance.filter(s => s === 'OT').length;
                const presentOvertimeDays = monthAttendance.filter(s => s === 'POT').length;
                const totalWorkingDays = presentDays + presentOvertimeDays + (overtimeDays * 0.5);
                const totalDays = monthAttendance.length;
                const attendancePercentage = totalDays > 0 ? Math.round((totalWorkingDays / totalDays) * 100) : 0;

                return [
                    emp.id,
                    emp.name,
                    emp.department,
                    presentDays,
                    absentDays,
                    offDays,
                    overtimeDays,
                    presentOvertimeDays,
                    totalWorkingDays.toFixed(1),
                    `${attendancePercentage}%`
                ];
            });

            doc.autoTable({
                head: [['ID', 'Employee Name', 'Department', 'Present', 'Absent', 'Off', 'OT', 'P+OT', 'Total', 'Att %']],
                body: attendanceSummary,
                startY: 60,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    halign: 'center'
                },
                headStyles: { 
                    fillColor: [244, 63, 94],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                tableWidth: 'auto',
                margin: { left: 15, right: 15 },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' },
                    1: { cellWidth: 30, halign: 'left' },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 12, halign: 'center' },
                    6: { cellWidth: 12, halign: 'center' },
                    7: { cellWidth: 15, halign: 'center' },
                    8: { cellWidth: 15, halign: 'center' },
                    9: { cellWidth: 16, halign: 'center' }
                }
            });

            // Department-wise summary
            const deptAttendance = {};
            employees.filter(emp => emp.status === 'Active').forEach(emp => {
                if (!deptAttendance[emp.department]) {
                    deptAttendance[emp.department] = { 
                        employees: 0,
                        totalPresent: 0, 
                        totalAbsent: 0,
                        totalOff: 0,
                        totalOT: 0,
                        totalPOT: 0,
                        totalDays: 0 
                    };
                }
                const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                deptAttendance[emp.department].employees++;
                deptAttendance[emp.department].totalPresent += monthAttendance.filter(s => s === 'P').length;
                deptAttendance[emp.department].totalAbsent += monthAttendance.filter(s => s === 'A').length;
                deptAttendance[emp.department].totalOff += monthAttendance.filter(s => s === 'Off').length;
                deptAttendance[emp.department].totalOT += monthAttendance.filter(s => s === 'OT').length;
                deptAttendance[emp.department].totalPOT += monthAttendance.filter(s => s === 'POT').length;
                deptAttendance[emp.department].totalDays += monthAttendance.length;
            });

            const deptSummary = Object.entries(deptAttendance).map(([dept, stats]) => {
                const workingDays = stats.totalPresent + stats.totalPOT + (stats.totalOT * 0.5);
                const attendancePercent = stats.totalDays > 0 ? Math.round((workingDays / stats.totalDays) * 100) : 0;
                return [
                    dept,
                    stats.employees,
                    stats.totalPresent,
                    stats.totalAbsent,
                    stats.totalOff,
                    stats.totalOT,
                    stats.totalPOT,
                    workingDays.toFixed(1),
                    `${attendancePercent}%`
                ];
            });

            let finalY = doc.lastAutoTable.finalY + 20;
            if (finalY > 250) {
                doc.addPage();
                finalY = 20;
            }

            // Add legend
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.text('Legend: P = Present, A = Absent, Off = Weekly Off, OT = Overtime Only, P+OT = Present + Overtime', 20, finalY);
            finalY += 15;

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('Department-wise Attendance Summary', 20, finalY);

            doc.autoTable({
                head: [['Department', 'Emp', 'Present', 'Absent', 'Off', 'OT', 'P+OT', 'Total', 'Att %']],
                body: deptSummary,
                startY: finalY + 10,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    halign: 'center'
                },
                headStyles: { 
                    fillColor: [100, 116, 139],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                tableWidth: 'auto',
                margin: { left: 15, right: 15 },
                columnStyles: {
                    0: { cellWidth: 25, halign: 'left' },
                    1: { cellWidth: 15, halign: 'center' },
                    2: { cellWidth: 18, halign: 'center' },
                    3: { cellWidth: 18, halign: 'center' },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 18, halign: 'center' },
                    7: { cellWidth: 18, halign: 'center' },
                    8: { cellWidth: 18, halign: 'center' }
                }
            });

            doc.save(`Attendance_Report_${currentMonth}.pdf`);
            
            Swal.fire({
                icon: 'success',
                title: 'Attendance Report Generated!',
                text: 'Professional attendance report has been downloaded.',
                timer: 2000,
                showConfirmButton: false
            });

            addActivity('Generated attendance report PDF');
        }

        async function generateComprehensiveReportPDF() {
            try {
                // Validate required data before proceeding
                if (!payrollData || !Array.isArray(payrollData) || payrollData.length === 0) {
                    throw new Error('No payroll data available for report generation');
                }
                if (!employees || !Array.isArray(employees)) {
                    throw new Error('Employee data not available');
                }
                if (!attendance || typeof attendance !== 'object') {
                    throw new Error('Attendance data not available');
                }
                if (!currentMonth) {
                    throw new Error('Current month not specified');
                }

                // Show loading indicator
                Swal.fire({
                    title: 'Generating Comprehensive Report',
                    text: 'Please wait while we prepare your PDF...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Check if we have a large dataset
                if (payrollData.length > 100) {
                    const result = await Swal.fire({
                        title: 'Large Dataset Detected',
                        text: `You have ${payrollData.length} employees. This may take some time to process. Continue?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Continue',
                        cancelButtonText: 'Cancel'
                    });
                    
                    if (!result.isConfirmed) {
                        return;
                    }
                    
                    // Show progress for large datasets
                    Swal.fire({
                        title: 'Processing Large Dataset',
                        text: 'Generating comprehensive report...',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

            // Helper function to add decorative line
            function addDecorativeLine(y, color = [40, 116, 240]) {
                doc.setDrawColor(color[0], color[1], color[2]);
                doc.setLineWidth(0.5);
                doc.line(20, y, 190, y);
            }

            // Helper function to add colored box background
            function addColoredBox(x, y, width, height, color, opacity = 0.1) {
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(x, y, width, height, 'F');
            }

            // Helper function for consistent date formatting
            function formatDate(date, options = { year: 'numeric', month: 'long', day: 'numeric' }) {
                try {
                    if (!date || isNaN(new Date(date))) {
                        return 'Invalid Date';
                    }
                    return new Date(date).toLocaleDateString('en-IN', options);
                } catch (error) {
                    return 'Invalid Date';
                }
            }

            // Helper function for consistent currency formatting
            function formatCurrency(amount) {
                return `₹ ${(amount || 0).toLocaleString('en-IN')}`;
            }

            // Professional section header function
            function addSectionHeader(title, sectionNumber, themeColor, description = '') {
                // Section background
                addColoredBox(10, 15, 190, 25, themeColor, 0.08);
                
                // Section number circle
                doc.setFillColor(themeColor[0], themeColor[1], themeColor[2]);
                doc.circle(25, 27, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.text(sectionNumber.toString(), 25, 30, { align: 'center' });
                
                // Section title
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(themeColor[0], themeColor[1], themeColor[2]);
                doc.text(title, 40, 25);
                
                // Section description
                if (description) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(75, 85, 99);
                    doc.text(description, 40, 33);
                }
                
                // Professional divider line
                addDecorativeLine(45, themeColor);
                
                // Page header for continuation pages
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                const reportPeriod = new Date(currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                doc.text(`Shishuraksha Hospital | Payroll Report | ${reportPeriod} | Page ${doc.getCurrentPageInfo().pageNumber}`, 200, 8, { align: 'right' });
                
                return 55; // Return Y position for content start
            }

            // Page break with section continuation
            function addPageBreakWithHeader(sectionTitle, sectionNumber, themeColor) {
                doc.addPage();
                
                // Continuation header
                addColoredBox(10, 10, 190, 15, themeColor, 0.05);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(themeColor[0], themeColor[1], themeColor[2]);
                doc.text(`${sectionNumber}. ${sectionTitle} (Continued)`, 15, 20);
                
                // Page info
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                const reportPeriod = new Date(currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                doc.text(`Shishuraksha Hospital | Payroll Report | ${reportPeriod} | Page ${doc.getCurrentPageInfo().pageNumber}`, 200, 8, { align: 'right' });
                
                addDecorativeLine(30, themeColor);
                return 40; // Return Y position for content start
            }

            // Professional Cover Page Design
            // Header background
            addColoredBox(10, 10, 190, 35, [40, 116, 240], 0.1);
            
            // Hospital logo area (placeholder)
            doc.setDrawColor(40, 116, 240);
            doc.setLineWidth(2);
            doc.circle(35, 27, 8);
            doc.setFontSize(8);
            doc.setTextColor(40, 116, 240);
            doc.text('SH', 35, 29, { align: 'center' });
            
            // Hospital header with enhanced styling
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.setTextColor(40, 116, 240);
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 25, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('Pediatric Healthcare Excellence • Comprehensive Employee Management', 105, 33, { align: 'center' });
            
            addDecorativeLine(50, [40, 116, 240]);
            
            // Main title with enhanced design
            addColoredBox(20, 65, 170, 25, [248, 250, 252], 1);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(31, 41, 55);
            doc.text('COMPREHENSIVE PAYROLL REPORT', 105, 78, { align: 'center' });
            
            // Report period with professional styling
            const reportDate = new Date(currentMonth);
            const monthYear = reportDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(14);
            doc.setTextColor(40, 116, 240);
            doc.text(`Report Period: ${monthYear}`, 105, 100, { align: 'center' });
            
            // Report classification
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(10);
            doc.setTextColor(220, 38, 38);
            doc.text('CONFIDENTIAL DOCUMENT', 105, 110, { align: 'center' });

            // Professional Key Metrics Section - Standardized Calculations
            const totalGross = payrollData.reduce((sum, emp) => sum + (emp.grossSalary || 0), 0);
            const totalNet = payrollData.reduce((sum, emp) => sum + (emp.netPay || 0), 0);
            const totalDeductions = payrollData.reduce((sum, emp) => sum + (emp.totalDeductions || 0), 0);
            const avgSalaryAmount = payrollData.length > 0 ? Math.round(totalNet / payrollData.length) : 0;
            
            // Metrics header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(31, 41, 55);
            doc.text('EXECUTIVE SUMMARY', 105, 130, { align: 'center' });
            
            // Four metric cards in a 2x2 grid
            const cardWidth = 80;
            const cardHeight = 30;
            const spacing = 10;
            
            // Card 1: Total Employees
            addColoredBox(25, 145, cardWidth, cardHeight, [16, 185, 129], 0.1);
            doc.setDrawColor(16, 185, 129);
            doc.setLineWidth(0.5);
            doc.rect(25, 145, cardWidth, cardHeight);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('TOTAL EMPLOYEES', 65, 155, { align: 'center' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(16, 185, 129);
            doc.text(`${payrollData.length}`, 65, 168, { align: 'center' });
            
            // Card 2: Gross Payroll
            addColoredBox(115, 145, cardWidth, cardHeight, [37, 99, 235], 0.1);
            doc.setDrawColor(37, 99, 235);
            doc.setLineWidth(0.5);
            doc.rect(115, 145, cardWidth, cardHeight);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('GROSS PAYROLL', 155, 155, { align: 'center' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text(`₹ ${totalGross.toLocaleString('en-IN')}`, 155, 168, { align: 'center' });
            
            // Card 3: Net Payroll
            addColoredBox(25, 185, cardWidth, cardHeight, [15, 118, 110], 0.1);
            doc.setDrawColor(15, 118, 110);
            doc.setLineWidth(0.5);
            doc.rect(25, 185, cardWidth, cardHeight);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('NET PAYROLL', 65, 195, { align: 'center' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(15, 118, 110);
            doc.text(`₹ ${totalNet.toLocaleString('en-IN')}`, 65, 208, { align: 'center' });
            
            // Card 4: Average Salary
            addColoredBox(115, 185, cardWidth, cardHeight, [168, 85, 247], 0.1);
            doc.setDrawColor(168, 85, 247);
            doc.setLineWidth(0.5);
            doc.rect(115, 185, cardWidth, cardHeight);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('AVERAGE SALARY', 155, 195, { align: 'center' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(168, 85, 247);
            doc.text(`₹ ${avgSalaryAmount.toLocaleString('en-IN')}`, 155, 208, { align: 'center' });

            // Professional footer section
            addDecorativeLine(230, [200, 200, 200]);
            
            // Report generation details
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            const generationDate = new Date();
            const dateStr = formatDate(generationDate);
            const timeStr = generationDate.toLocaleTimeString('en-IN', {hour12: false});
            doc.text(`Report Generated: ${dateStr} at ${timeStr} IST`, 20, 245);
            
            // Report metadata
            doc.text(`Report ID: SH-PR-${generationDate.getFullYear()}${String(generationDate.getMonth()+1).padStart(2,'0')}${String(generationDate.getDate()).padStart(2,'0')}-${String(generationDate.getHours()).padStart(2,'0')}${String(generationDate.getMinutes()).padStart(2,'0')}`, 20, 255);
            
            // Confidentiality notice
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(8);
            doc.setTextColor(220, 38, 38);
            doc.text('CONFIDENTIAL: This document contains sensitive employee and financial information.', 105, 270, { align: 'center' });
            doc.text('Unauthorized access, copying, or distribution is strictly prohibited.', 105, 278, { align: 'center' });
            
            // Footer branding
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text('Powered by Shishuraksha Hospital Management System', 105, 290, { align: 'center' });

            // Professional Table of Contents
            doc.addPage();
            
            // Page header background
            addColoredBox(15, 15, 180, 20, [40, 116, 240], 0.1);
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(40, 116, 240);
            doc.text('TABLE OF CONTENTS', 105, 28, { align: 'center' });
            
            addDecorativeLine(40, [40, 116, 240]);
            
            // Report overview
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            doc.text('This comprehensive report contains detailed payroll analysis and employee data for the specified period.', 105, 52, { align: 'center' });
            
            // Professional TOC with navigation
            const tocItems = [
                { 
                    title: '1. Executive Summary', 
                    description: 'Key metrics and financial overview', 
                    page: 'Page 3',
                    bookmark: 'executive-summary'
                },
                { 
                    title: '2. Employee Payroll Details', 
                    description: 'Complete salary breakdown by employee', 
                    page: 'Page 4+',
                    bookmark: 'payroll-details'
                },
                { 
                    title: '3. Department Analysis', 
                    description: 'Cost center and departmental analysis', 
                    page: 'See Index',
                    bookmark: 'department-analysis'
                },
                { 
                    title: '4. Attendance Summary', 
                    description: 'Working days and attendance metrics', 
                    page: 'See Index',
                    bookmark: 'attendance-summary'
                },
                { 
                    title: '5. Bank Transfer Details', 
                    description: 'Payment processing and transfer data', 
                    page: 'See Index',
                    bookmark: 'bank-transfers'
                },
                { 
                    title: '6. Compliance Report', 
                    description: 'PF, ESIC and statutory compliance data', 
                    page: 'See Index',
                    bookmark: 'compliance-report'
                }
            ];
            
            // TOC header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(31, 41, 55);
            doc.text('SECTION', 25, 70);
            doc.text('DESCRIPTION', 85, 70);
            doc.text('PAGE', 175, 70);
            
            addDecorativeLine(75, [200, 200, 200]);
            
            tocItems.forEach((item, index) => {
                const y = 90 + (index * 18);
                
                // Alternating background
                if (index % 2 === 0) {
                    addColoredBox(20, y - 8, 170, 15, [248, 250, 252], 1);
                }
                
                // Section title
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(40, 116, 240);
                doc.text(item.title, 25, y);
                
                // Description
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.setTextColor(75, 85, 99);
                doc.text(item.description, 85, y);
                
                // Page number with navigation styling
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(40, 116, 240);
                doc.text(item.page, 175, y);
                
            });
            
            // Professional footer note
            addDecorativeLine(205, [200, 200, 200]);
            
            // Report notes
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(31, 41, 55);
            doc.text('REPORT NOTES', 105, 220, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(75, 85, 99);
            doc.text('• All monetary values are displayed in Indian Rupees (₹) with Indian formatting', 25, 235);
            doc.text('• Data reflects information as of the report generation date', 25, 245);
            doc.text('• This report contains confidential payroll information', 25, 255);
            doc.text('• For discrepancies or queries, contact HR Department', 25, 265);

            // Executive Summary Section
            doc.addPage();
            
            // Add bookmark for navigation
            doc.setPage(doc.getCurrentPageInfo().pageNumber);
            
            const executiveSummaryY = addSectionHeader(
                'EXECUTIVE SUMMARY', 
                1, 
                [51, 51, 51], 
                'High-level overview of payroll metrics and key performance indicators'
            );
            
            // Key metrics in professional grid layout - Use existing calculated values
            // totalDeductions and avgSalaryAmount already calculated above
            
            // Gross Payroll Box
            doc.setDrawColor(59, 130, 246);
            doc.setLineWidth(1);
            doc.rect(25, executiveSummaryY + 10, 80, 30);
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.text('GROSS PAYROLL', 65, 65, { align: 'center' });
            doc.setFontSize(16);
            doc.setTextColor(59, 130, 246);
            doc.text(`₹ ${totalGross.toLocaleString('en-IN')}`, 65, 78, { align: 'center' });
            
            // Net Payroll Box
            doc.setDrawColor(16, 185, 129);
            doc.rect(115, 55, 80, 30);
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.text('NET PAYROLL', 155, 65, { align: 'center' });
            doc.setFontSize(16);
            doc.setTextColor(16, 185, 129);
            doc.text(`₹ ${totalNet.toLocaleString('en-IN')}`, 155, 78, { align: 'center' });
            
            // Total Deductions Box
            doc.setDrawColor(239, 68, 68);
            doc.rect(25, 95, 80, 30);
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.text('TOTAL DEDUCTIONS', 65, 105, { align: 'center' });
            doc.setFontSize(16);
            doc.setTextColor(239, 68, 68);
            doc.text(`₹ ${totalDeductions.toLocaleString('en-IN')}`, 65, 118, { align: 'center' });
            
            // Average Salary Box
            doc.setDrawColor(168, 85, 247);
            doc.rect(115, 95, 80, 30);
            doc.setFontSize(11);
            doc.setTextColor(75, 85, 99);
            doc.text('AVERAGE SALARY', 155, 105, { align: 'center' });
            doc.setFontSize(16);
            doc.setTextColor(168, 85, 247);
            doc.text(`₹ ${avgSalaryAmount.toLocaleString('en-IN')}`, 155, 118, { align: 'center' });
            
            // Summary text without emojis
            doc.setFontSize(14);
            doc.setTextColor(51, 51, 51);
            const payrollPeriod = new Date(currentMonth).toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
            doc.text(`Payroll Period: ${payrollPeriod}`, 25, 150);
            
            doc.setFontSize(12);
            doc.setTextColor(75, 85, 99);
            const summaryText = [
                `This comprehensive report covers ${payrollData.length} active employees across multiple departments.`,
                `The organization's total payroll obligation amounts to ₹${totalNet.toLocaleString('en-IN')}.`,
                `Deduction rate stands at ${Math.round((totalDeductions/totalGross)*100)}% of gross salary.`,
                `Average employee compensation is ${formatCurrency(avgSalaryAmount)} per month.`,
                `All statutory compliances (PF, ESIC, PT) have been calculated and applied.`
            ];
            
            summaryText.forEach((line, index) => {
                doc.text(line, 25, 170 + (index * 15));
            });
            
            // Professional note
            addDecorativeLine(250, [200, 200, 200]);
            doc.setFontSize(10);
            doc.setTextColor(120, 120, 120);
            doc.text('Note: All amounts are in Indian Rupees (INR). Calculations are based on current statutory rates.', 105, 265, { align: 'center' });

            // Payroll Summary Section
            doc.addPage();
            
            const payrollSummaryY = addSectionHeader(
                'EMPLOYEE PAYROLL DETAILS', 
                2, 
                [37, 99, 235], 
                'Comprehensive salary breakdown for all employees'
            );

            // Process payroll data in chunks to prevent freezing
            const payrollTableData = [];
            await new Promise(resolve => {
                let index = 0;
                const chunkSize = 100;
                
                function processChunk() {
                    const endIndex = Math.min(index + chunkSize, payrollData.length);
                    
                    for (let i = index; i < endIndex; i++) {
                        const emp = payrollData[i];
                        payrollTableData.push([
                            emp.id,
                            emp.name.substring(0, 15),
                            emp.department.substring(0, 8),
                            emp.workingDays,
                            `₹${emp.basicSalary.toLocaleString('en-IN')}`,
                            `₹${emp.grossSalary.toLocaleString('en-IN')}`,
                            `₹${emp.totalDeductions.toLocaleString('en-IN')}`,
                            `₹${emp.netPay.toLocaleString('en-IN')}`
                        ]);
                    }
                    
                    index = endIndex;
                    
                    if (index < payrollData.length) {
                        setTimeout(processChunk, 0);
                    } else {
                        resolve();
                    }
                }
                
                processChunk();
            });

            doc.autoTable({
                head: [['ID', 'Name', 'Dept', 'Days', 'Basic', 'Gross', 'Ded.', 'Net']],
                body: payrollTableData,
                startY: payrollSummaryY,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [37, 99, 235],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 9,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' },    // ID
                    1: { cellWidth: 35, halign: 'left' },      // Name
                    2: { cellWidth: 20, halign: 'center' },    // Dept
                    3: { cellWidth: 15, halign: 'center' },    // Days
                    4: { cellWidth: 25, halign: 'right' },     // Basic
                    5: { cellWidth: 25, halign: 'right' },     // Gross
                    6: { cellWidth: 25, halign: 'right' },     // Deductions
                    7: { cellWidth: 25, halign: 'right' }      // Net
                },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    // Add section continuation header on new pages
                    if (data.pageNumber > 1) {
                        addPageBreakWithHeader('EMPLOYEE PAYROLL DETAILS', 2, [37, 99, 235]);
                    }
                }
            });

            // Department Analysis Section
            doc.addPage();
            
            const departmentAnalysisY = addSectionHeader(
                'DEPARTMENT ANALYSIS', 
                3, 
                [139, 92, 246], 
                'Cost center analysis and departmental performance metrics'
            );

            // Calculate department summaries with async processing
            const deptAnalysis = {};
            
            // Process in chunks to prevent browser freezing
            await new Promise(resolve => {
                let index = 0;
                const chunkSize = 50;
                
                function processChunk() {
                    const endIndex = Math.min(index + chunkSize, payrollData.length);
                    
                    for (let i = index; i < endIndex; i++) {
                        const emp = payrollData[i];
                        if (!deptAnalysis[emp.department]) {
                            deptAnalysis[emp.department] = {
                                count: 0,
                                totalBasic: 0,
                                totalGross: 0,
                                totalDeductions: 0,
                                totalNet: 0,
                                avgSalary: 0
                            };
                        }
                        deptAnalysis[emp.department].count++;
                        deptAnalysis[emp.department].totalBasic += emp.basicSalary;
                        deptAnalysis[emp.department].totalGross += emp.grossSalary;
                        deptAnalysis[emp.department].totalDeductions += emp.totalDeductions;
                        deptAnalysis[emp.department].totalNet += emp.netPay;
                    }
                    
                    index = endIndex;
                    
                    if (index < payrollData.length) {
                        setTimeout(processChunk, 0); // Allow browser to breathe
                    } else {
                        resolve();
                    }
                }
                
                processChunk();
            });

            // Calculate averages consistently using net pay
            Object.values(deptAnalysis).forEach(dept => {
                dept.avgSalary = dept.count > 0 ? Math.round(dept.totalNet / dept.count) : 0;
            });

            const deptTableData = Object.entries(deptAnalysis).map(([dept, stats]) => [
                dept,
                stats.count,
                `₹ ${stats.totalGross.toLocaleString('en-IN')}`,
                `₹ ${stats.totalDeductions.toLocaleString('en-IN')}`,
                `₹ ${stats.totalNet.toLocaleString('en-IN')}`,
                `₹ ${stats.avgSalary.toLocaleString('en-IN')}`,
                `${Math.round((stats.totalNet / totalNet) * 100)}%`
            ]);

            doc.autoTable({
                head: [['Department', 'Employees', 'Total Gross', 'Deductions', 'Net Pay', 'Avg Salary', '% of Total']],
                body: deptTableData,
                startY: departmentAnalysisY,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 9,
                    cellPadding: 3,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [139, 92, 246],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 10,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 30, halign: 'left' },      // Department
                    1: { cellWidth: 20, halign: 'center' },    // Employees
                    2: { cellWidth: 25, halign: 'right' },     // Total Gross
                    3: { cellWidth: 25, halign: 'right' },     // Deductions
                    4: { cellWidth: 25, halign: 'right' },     // Net Pay
                    5: { cellWidth: 25, halign: 'right' },     // Avg Salary
                    6: { cellWidth: 20, halign: 'center' }     // % of Total
                },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    // Add section continuation header on new pages
                    if (data.pageNumber > 1) {
                        addPageBreakWithHeader('DEPARTMENT ANALYSIS', 3, [139, 92, 246]);
                    }
                }
            });

            // Attendance Summary Section
            doc.addPage();
            
            const attendanceSummaryY = addSectionHeader(
                'ATTENDANCE SUMMARY', 
                4, 
                [15, 118, 110], 
                'Working days analysis and attendance performance metrics'
            );

            const attendanceSummaryData = employees.filter(emp => emp.status === 'Active').map(emp => {
                const monthAttendance = attendance[currentMonth]?.[emp.id] || [];
                const presentDays = monthAttendance.filter(s => s === 'P').length;
                const absentDays = monthAttendance.filter(s => s === 'A').length;
                const offDays = monthAttendance.filter(s => s === 'Off').length;
                const overtimeDays = monthAttendance.filter(s => s === 'OT').length;
                const presentOvertimeDays = monthAttendance.filter(s => s === 'POT').length;
                const totalWorkingDays = presentDays + presentOvertimeDays + (overtimeDays * 0.5);
                const totalDays = monthAttendance.length;
                const attendancePercentage = totalDays > 0 ? Math.round((totalWorkingDays / totalDays) * 100) : 0;

                return [
                    emp.id,
                    emp.name.substring(0, 20),
                    emp.department.substring(0, 10),
                    presentDays,
                    absentDays,
                    offDays,
                    overtimeDays,
                    presentOvertimeDays,
                    totalWorkingDays.toFixed(1),
                    `${attendancePercentage}%`
                ];
            });

            doc.autoTable({
                head: [['ID', 'Name', 'Dept', 'Present', 'Absent', 'Off', 'OT', 'P+OT', 'Total', 'Att %']],
                body: attendanceSummaryData,
                startY: attendanceSummaryY,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [15, 118, 110],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 9,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 12, halign: 'center' },    // ID
                    1: { cellWidth: 30, halign: 'left' },      // Name
                    2: { cellWidth: 18, halign: 'center' },    // Dept
                    3: { cellWidth: 16, halign: 'center' },    // Present
                    4: { cellWidth: 16, halign: 'center' },    // Absent
                    5: { cellWidth: 12, halign: 'center' },    // Off
                    6: { cellWidth: 12, halign: 'center' },    // OT
                    7: { cellWidth: 16, halign: 'center' },    // P+OT
                    8: { cellWidth: 16, halign: 'center' },    // Total
                    9: { cellWidth: 18, halign: 'center' }     // Att %
                },
                margin: { left: 10, right: 10 },
                didDrawPage: function(data) {
                    // Add section continuation header on new pages
                    if (data.pageNumber > 1) {
                        addPageBreakWithHeader('ATTENDANCE SUMMARY', 4, [15, 118, 110]);
                    }
                }
            });

            // Bank Transfer Details Section
            doc.addPage();
            
            const bankTransferY = addSectionHeader(
                'BANK TRANSFER DETAILS', 
                5, 
                [16, 185, 129], 
                'Payment processing data and bank transfer information'
            );
            
            // Transfer summary in attractive format
            addColoredBox(25, bankTransferY + 5, 160, 25, [16, 185, 129], 0.05);
            doc.setFontSize(14);
            doc.setTextColor(16, 185, 129);
            doc.text(`Total Transfer Amount: ₹${totalNet.toLocaleString('en-IN')}`, 30, 60);
            doc.setFontSize(12);
            doc.setTextColor(75, 85, 99);
            doc.text(`Number of Transfers: ${payrollData.length} employees`, 30, 70);
            doc.text(`Processing Date: ${new Date().toLocaleDateString()}`, 120, 70);

            const bankTableData = payrollData.map(emp => [
                emp.id,
                emp.name.substring(0, 18),
                emp.bankAccount || 'N/A',
                emp.ifsc || 'N/A',
                `₹${emp.netPay.toLocaleString('en-IN')}`,
                'Pending'
            ]);

            doc.autoTable({
                head: [['Emp ID', 'Employee Name', 'Account Number', 'IFSC Code', 'Transfer Amount', 'Status']],
                body: bankTableData,
                startY: bankTransferY + 35,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [16, 185, 129],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 9,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 20, halign: 'center' },    // Emp ID
                    1: { cellWidth: 40, halign: 'left' },      // Employee Name
                    2: { cellWidth: 35, halign: 'center' },    // Account Number
                    3: { cellWidth: 25, halign: 'center' },    // IFSC Code
                    4: { cellWidth: 30, halign: 'right' },     // Transfer Amount
                    5: { cellWidth: 20, halign: 'center' }     // Status
                },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    // Add section continuation header on new pages
                    if (data.pageNumber > 1) {
                        addPageBreakWithHeader('BANK TRANSFER DETAILS', 5, [16, 185, 129]);
                    }
                }
            });

            // Bank Summary by Account Type
            let bankSummaryY = doc.lastAutoTable.finalY + 20;
            if (bankSummaryY > 250) {
                doc.addPage();
                bankSummaryY = 30;
            }

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('Bank Transfer Summary:', 20, bankSummaryY);

            // Calculate safe bank summary values
            const avgTransfer = payrollData.length > 0 ? Math.round(totalNet / payrollData.length) : 0;
            const netPayAmounts = payrollData.map(emp => emp.netPay || 0).filter(amount => amount > 0);
            const largestTransfer = netPayAmounts.length > 0 ? Math.max(...netPayAmounts) : 0;
            const smallestTransfer = netPayAmounts.length > 0 ? Math.min(...netPayAmounts) : 0;
            
            const bankSummary = [
                ['Total Employees', payrollData.length],
                ['Total Amount', formatCurrency(totalNet)],
                ['Average Transfer', formatCurrency(avgTransfer)],
                ['Largest Transfer', formatCurrency(largestTransfer)],
                ['Smallest Transfer', formatCurrency(smallestTransfer)]
            ];

            doc.autoTable({
                head: [['Summary Item', 'Value']],
                body: bankSummary,
                startY: bankSummaryY + 10,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 10,
                    cellPadding: 4,
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [100, 116, 139],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 50, halign: 'left' },      // Summary Item
                    1: { cellWidth: 40, halign: 'right' }      // Value
                },
                theme: 'grid',
                margin: { left: 20, right: 20 }
            });

            // Compliance Report Section
            doc.addPage();
            
            const complianceReportY = addSectionHeader(
                'COMPLIANCE REPORT', 
                6, 
                [168, 85, 247], 
                'PF, ESIC and statutory compliance data analysis'
            );
            
            // PF/ESIC Summary with visual cards
            const totalPF = payrollData.reduce((sum, emp) => sum + (emp.pf || 0), 0);
            const totalESIC = payrollData.reduce((sum, emp) => sum + (emp.esic || 0), 0);
            const totalPT = payrollData.reduce((sum, emp) => sum + (emp.pt || 0), 0);
            const totalStatutory = totalPF + totalESIC + totalPT;

            // PF Card
            addColoredBox(25, complianceReportY + 10, 50, 30, [59, 130, 246], 0.1);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('PF DEDUCTION', 50, 62, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(59, 130, 246);
            doc.text(`₹${totalPF.toLocaleString('en-IN')}`, 50, 75, { align: 'center' });

            // ESIC Card
            addColoredBox(85, 55, 50, 30, [16, 185, 129], 0.1);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('ESIC DEDUCTION', 110, 62, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(16, 185, 129);
            doc.text(`₹${totalESIC.toLocaleString('en-IN')}`, 110, 75, { align: 'center' });

            // PT Card  
            addColoredBox(145, 55, 50, 30, [245, 158, 11], 0.1);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('PROF. TAX', 170, 62, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(245, 158, 11);
            doc.text(`₹${totalPT.toLocaleString('en-IN')}`, 170, 75, { align: 'center' });

            // Total statutory box
            addColoredBox(60, 95, 90, 20, [168, 85, 247], 0.1);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('TOTAL STATUTORY DEDUCTIONS', 105, 102, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(168, 85, 247);
            doc.text(`₹${totalStatutory.toLocaleString('en-IN')}`, 105, 110, { align: 'center' });

            // Compliance Details Table
            const complianceTableData = payrollData.map(emp => [
                emp.id,
                emp.name.substring(0, 18),
                emp.uan || 'N/A',
                emp.esicNumber || 'N/A',
                `₹${(emp.pf || 0).toLocaleString('en-IN')}`,
                `₹${(emp.esic || 0).toLocaleString('en-IN')}`,
                `₹${(emp.pt || 0).toLocaleString('en-IN')}`,
                `₹${((emp.pf || 0) + (emp.esic || 0) + (emp.pt || 0)).toLocaleString('en-IN')}`
            ]);

            doc.autoTable({
                head: [['Emp ID', 'Name', 'UAN', 'ESIC No', 'PF Amount', 'ESIC Amount', 'PT Amount', 'Total Deductions']],
                body: complianceTableData,
                startY: complianceReportY + 70,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [168, 85, 247],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 9,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 16, halign: 'center' },    // Emp ID
                    1: { cellWidth: 30, halign: 'left' },      // Name
                    2: { cellWidth: 25, halign: 'center' },    // UAN
                    3: { cellWidth: 20, halign: 'center' },    // ESIC No
                    4: { cellWidth: 20, halign: 'right' },     // PF Amount
                    5: { cellWidth: 20, halign: 'right' },     // ESIC Amount
                    6: { cellWidth: 18, halign: 'right' },     // PT Amount
                    7: { cellWidth: 25, halign: 'right' }      // Total Deductions
                },
                margin: { left: 12, right: 12 },
                didDrawPage: function(data) {
                    // Add section continuation header on new pages
                    if (data.pageNumber > 1) {
                        addPageBreakWithHeader('COMPLIANCE REPORT', 6, [168, 85, 247]);
                    }
                }
            });

            // Compliance Statistics
            let complianceStatsY = doc.lastAutoTable.finalY + 20;
            if (complianceStatsY > 250) {
                doc.addPage();
                complianceStatsY = 30;
            }

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('Compliance Statistics:', 20, complianceStatsY);

            const employeesWithUAN = payrollData.filter(emp => emp.uan && emp.uan !== 'N/A').length;
            const employeesWithESIC = payrollData.filter(emp => emp.esicNumber && emp.esicNumber !== 'N/A').length;
            const pfEligible = payrollData.filter(emp => (emp.pf || 0) > 0).length;
            const esicEligible = payrollData.filter(emp => (emp.esic || 0) > 0).length;

            const complianceStats = [
                ['Employees with UAN', `${employeesWithUAN}/${payrollData.length}`, `${Math.round((employeesWithUAN/payrollData.length)*100)}%`],
                ['Employees with ESIC No', `${employeesWithESIC}/${payrollData.length}`, `${Math.round((employeesWithESIC/payrollData.length)*100)}%`],
                ['PF Eligible Employees', `${pfEligible}/${payrollData.length}`, `${Math.round((pfEligible/payrollData.length)*100)}%`],
                ['ESIC Eligible Employees', `${esicEligible}/${payrollData.length}`, `${Math.round((esicEligible/payrollData.length)*100)}%`]
            ];

            doc.autoTable({
                head: [['Compliance Item', 'Count', 'Percentage']],
                body: complianceStats,
                startY: complianceStatsY + 10,
                showHead: 'everyPage',
                styles: { 
                    fontSize: 10,
                    cellPadding: 4,
                    halign: 'center',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.5,
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                },
                headStyles: { 
                    fillColor: [100, 116, 139],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 60, halign: 'left' },      // Compliance Item
                    1: { cellWidth: 20, halign: 'center' },    // Count
                    2: { cellWidth: 25, halign: 'center' }     // Percentage
                },
                margin: { left: 20, right: 20 }
            });

            // Add final page with document summary
            doc.addPage();
            
            const finalPageY = addSectionHeader(
                'DOCUMENT SUMMARY', 
                'END', 
                [100, 116, 139], 
                'Report completion summary and metadata'
            );
            
            // Document statistics
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(31, 41, 55);
            doc.text('REPORT STATISTICS', 25, finalPageY + 15);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(75, 85, 99);
            
            const finalStats = [
                `Total Pages: ${doc.getCurrentPageInfo().pageNumber}`,
                `Total Employees Processed: ${payrollData.length}`,
                `Report Generation Time: ${new Date().toLocaleString('en-IN')}`,
                `Report Period: ${formatDate(new Date(currentMonth), { month: 'long', year: 'numeric' })}`,
                `Total Gross Payroll: ${formatCurrency(totalGross)}`,
                `Total Net Payroll: ${formatCurrency(totalNet)}`,
                `System Version: Shishuraksha HMS v2.1`
            ];
            
            finalStats.forEach((stat, index) => {
                doc.text(`• ${stat}`, 25, finalPageY + 35 + (index * 12));
            });
            
            // Report completion notice
            addDecorativeLine(finalPageY + 140, [100, 116, 139]);
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(10);
            doc.setTextColor(40, 116, 240);
            doc.text('*** END OF REPORT ***', 105, finalPageY + 155, { align: 'center' });
            
            // Create professional filename
            const filenameDate = new Date(currentMonth);
            const year = filenameDate.getFullYear();
            const month = filenameDate.toLocaleDateString('en-US', { month: 'long' });
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `Shishuraksha_Hospital_Payroll_Report_${month}_${year}_Generated_${timestamp}.pdf`;
            
            doc.save(filename);
            
            Swal.fire({
                icon: 'success',
                title: 'Master Report Generated!',
                text: 'Complete comprehensive report with all details has been downloaded.',
                timer: 2000,
                showConfirmButton: false
            });

            addActivity('Generated comprehensive PDF report');
            
        } catch (error) {
                console.error('Error generating comprehensive report PDF:', error);
                
                // Hide loading indicator and show error
                Swal.fire({
                    icon: 'error',
                    title: 'PDF Generation Failed',
                    text: 'An error occurred while generating the comprehensive report. Please try again with a smaller dataset or contact support.',
                    footer: `Error: ${error.message}`,
                    showConfirmButton: true
                });
                
                // Log the error activity
                addActivity('Failed to generate comprehensive PDF report');
            }
        }

        function generateDepartmentSummary() {
            const wb = XLSX.utils.book_new();
            
            // Department Summary
            const deptSummary = {};
            payrollData.forEach(emp => {
                if (!deptSummary[emp.department]) {
                    deptSummary[emp.department] = {
                        'Department': emp.department,
                        'Employee Count': 0,
                        'Total Basic': 0,
                        'Total Gross': 0,
                        'Total Deductions': 0,
                        'Total Net': 0,
                        'Average Salary': 0
                    };
                }
                deptSummary[emp.department]['Employee Count']++;
                deptSummary[emp.department]['Total Basic'] += emp.basicSalary;
                deptSummary[emp.department]['Total Gross'] += emp.grossSalary;
                deptSummary[emp.department]['Total Deductions'] += emp.totalDeductions;
                deptSummary[emp.department]['Total Net'] += emp.netPay;
            });
            
            // Calculate averages
            Object.values(deptSummary).forEach(dept => {
                dept['Average Salary'] = Math.round(dept['Total Net'] / dept['Employee Count']);
            });
            
            const deptSheet = XLSX.utils.json_to_sheet(Object.values(deptSummary));
            XLSX.utils.book_append_sheet(wb, deptSheet, 'Department_Summary');
            
            // Employee details by department
            Object.keys(deptSummary).forEach(dept => {
                const deptEmployees = payrollData.filter(emp => emp.department === dept);
                const empData = deptEmployees.map(emp => ({
                    'Employee ID': emp.id,
                    'Name': emp.name,
                    'Designation': emp.designation,
                    'Basic Salary': emp.basicSalary,
                    'Gross Salary': emp.grossSalary,
                    'Total Deductions': emp.totalDeductions,
                    'Net Pay': emp.netPay
                }));
                
                const empSheet = XLSX.utils.json_to_sheet(empData);
                XLSX.utils.book_append_sheet(wb, empSheet, dept.replace(/[^a-zA-Z0-9]/g, '_'));
            });
            
            XLSX.writeFile(wb, `Department_Summary_${currentMonth}.xlsx`);
            
            Swal.fire({
                icon: 'success',
                title: 'Department Summary Generated!',
                text: 'Excel file with department analysis has been downloaded.',
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity('Generated department summary');
        }

        // Search Functions for Attendance and Payroll
        function searchAttendance() {
            const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
            const attendanceRows = document.querySelectorAll('#attendanceTableBody tr');
            
            attendanceRows.forEach(row => {
                // Get employee data from the row's data attribute (we'll need to add this)
                const employeeId = row.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                
                if (employee) {
                    const employeeName = employee.name.toLowerCase();
                    const empId = employee.id.toLowerCase();
                    const department = employee.department.toLowerCase();
                    
                    if (employeeName.includes(searchTerm) || 
                        empId.includes(searchTerm) || 
                        department.includes(searchTerm)) {
                        row.style.display = '';
                        row.style.backgroundColor = searchTerm ? 'rgba(59, 130, 246, 0.1)' : '';
                        row.style.border = searchTerm ? '1px solid rgba(59, 130, 246, 0.3)' : '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Show search result count
            const visibleRows = Array.from(attendanceRows).filter(row => row.style.display !== 'none').length;
            showSearchResults(visibleRows, 'attendance');
        }

        function clearAttendanceSearch() {
            document.getElementById('attendanceSearch').value = '';
            const attendanceRows = document.querySelectorAll('#attendanceTableBody tr');
            attendanceRows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
                row.style.border = '';
            });
            hideSearchResults();
        }

        function highlightEmployee() {
            const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
            if (!searchTerm) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Search Term',
                    text: 'Please enter an employee name, ID, or department to search.'
                });
                return;
            }

            const attendanceRows = document.querySelectorAll('#attendanceTableBody tr');
            let foundEmployee = null;

            attendanceRows.forEach(row => {
                const employeeId = row.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                
                if (employee && (employee.name.toLowerCase().includes(searchTerm) || 
                    employee.id.toLowerCase().includes(searchTerm) || 
                    employee.department.toLowerCase().includes(searchTerm))) {
                    
                    row.style.backgroundColor = '#fef3c7';
                    row.style.border = '3px solid #f59e0b';
                    row.style.borderRadius = '8px';
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    foundEmployee = employee;
                } else {
                    row.style.backgroundColor = '';
                    row.style.border = '';
                    row.style.borderRadius = '';
                }
            });

            if (foundEmployee) {
                // Calculate current month attendance for this employee
                const monthAttendance = attendance[currentMonth]?.[foundEmployee.id] || [];
                const presentDays = monthAttendance.filter(s => s === 'P' || s === 'POT').length;
                const absentDays = monthAttendance.filter(s => s === 'A').length;
                const overtimeDays = monthAttendance.filter(s => s === 'OT' || s === 'POT').length;

                Swal.fire({
                    icon: 'success',
                    title: 'Employee Found & Highlighted!',
                    html: `
                        <div class="text-left">
                            <p><strong>Name:</strong> ${foundEmployee.name}</p>
                            <p><strong>ID:</strong> ${foundEmployee.id}</p>
                            <p><strong>Department:</strong> ${foundEmployee.department}</p>
                            <hr class="my-2">
                            <p><strong>This Month:</strong></p>
                            <p>Present: ${presentDays} days</p>
                            <p>Absent: ${absentDays} days</p>
                            <p>Overtime: ${overtimeDays} days</p>
                        </div>
                    `,
                    confirmButtonText: 'Mark Today\'s Attendance',
                    showCancelButton: true,
                    cancelButtonText: 'Close'
                }).then((result) => {
                    if (result.isConfirmed) {
                        markTodayAttendanceForEmployee(foundEmployee.id);
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Employee Not Found',
                    text: 'No employee found matching your search criteria.'
                });
            }
        }

        function markTodayAttendanceForEmployee(empId) {
            const today = new Date();
            const currentDate = today.getDate();
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]);
            
            // Check if we're in the correct month
            if (today.getFullYear() !== year || (today.getMonth() + 1) !== month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Wrong Month',
                    text: 'You can only mark today\'s attendance for the current month.'
                });
                return;
            }

            Swal.fire({
                title: 'Mark Today\'s Attendance',
                text: `Select attendance status for today (${today.toDateString()}):`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Present',
                cancelButtonText: 'Cancel',
                showDenyButton: true,
                denyButtonText: 'Absent',
                showCloseButton: true,
                footer: '<button onclick="markEmployeeStatus(\'' + empId + '\', ' + (currentDate - 1) + ', \'OT\')" class="swal2-confirm swal2-styled" style="background-color: #f59e0b;">Overtime</button>'
            }).then((result) => {
                if (result.isConfirmed) {
                    markEmployeeStatus(empId, currentDate - 1, 'P');
                } else if (result.isDenied) {
                    markEmployeeStatus(empId, currentDate - 1, 'A');
                }
            });
        }

        function markEmployeeStatus(empId, dayIndex, status) {
            // Ensure attendance structure exists
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
            }
            if (!attendance[currentMonth][empId]) {
                attendance[currentMonth][empId] = generateMonthlyAttendance();
            }
            
            attendance[currentMonth][empId][dayIndex] = status;
            displayAttendance();
            saveToLocalStorage();
            
            const employee = employees.find(emp => emp.id === empId);
            const statusText = status === 'P' ? 'Present' : status === 'A' ? 'Absent' : status === 'OT' ? 'Overtime' : status;
            
            Swal.fire({
                icon: 'success',
                title: 'Attendance Marked!',
                text: `${employee.name} marked as ${statusText} for today.`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function searchPayroll() {
            const searchTerm = document.getElementById('payrollSearch').value.toLowerCase();
            const payrollRows = document.querySelectorAll('#payrollTableBody tr');
            
            payrollRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const employeeId = cells[0].textContent.toLowerCase();
                    const employeeName = cells[1].textContent.toLowerCase();
                    const department = cells[2].textContent.toLowerCase();
                    const netPay = cells[cells.length - 2].textContent.toLowerCase(); // Net pay is usually second to last
                    
                    if (employeeName.includes(searchTerm) || 
                        employeeId.includes(searchTerm) || 
                        department.includes(searchTerm) ||
                        netPay.includes(searchTerm)) {
                        row.style.display = '';
                        row.style.backgroundColor = searchTerm ? 'rgba(16, 185, 129, 0.1)' : '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Show search result count
            const visibleRows = Array.from(payrollRows).filter(row => row.style.display !== 'none').length;
            showSearchResults(visibleRows, 'payroll');
        }

        function clearPayrollSearch() {
            document.getElementById('payrollSearch').value = '';
            const payrollRows = document.querySelectorAll('#payrollTableBody tr');
            payrollRows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
            });
            hideSearchResults();
        }

        function showEmployeePayDetails() {
            const searchTerm = document.getElementById('payrollSearch').value.toLowerCase();
            if (!searchTerm) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Search Term',
                    text: 'Please enter an employee name, ID, or department to view details.'
                });
                return;
            }

            const employee = payrollData.find(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.department.toLowerCase().includes(searchTerm)
            );

            if (employee) {
                const payrollRows = document.querySelectorAll('#payrollTableBody tr');
                payrollRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0 && cells[0].textContent === employee.id) {
                        row.style.backgroundColor = '#dcfce7';
                        row.style.border = '2px solid #10b981';
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        row.style.backgroundColor = '';
                        row.style.border = '';
                    }
                });

                Swal.fire({
                    title: `${employee.name} Pay Details`,
                    html: `
                        <div class="text-left">
                            <p><strong>Employee ID:</strong> ${employee.id}</p>
                            <p><strong>Department:</strong> ${employee.department}</p>
                            <p><strong>Working Days:</strong> ${employee.workingDays}</p>
                            <p><strong>Basic Salary:</strong> ₹${employee.basicSalary.toLocaleString('en-IN')}</p>
                            <p><strong>Gross Salary:</strong> ₹${employee.grossSalary.toLocaleString('en-IN')}</p>
                            <p><strong>Total Deductions:</strong> ₹${employee.totalDeductions.toLocaleString('en-IN')}</p>
                            <p><strong>Net Pay:</strong> <span style="color: #10b981; font-weight: bold; font-size: 1.1em;">₹${employee.netPay.toLocaleString('en-IN')}</span></p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonColor: '#10b981',
                    confirmButtonText: 'Generate Payslip'
                }).then((result) => {
                    if (result.isConfirmed) {
                        generateIndividualPayslip(employee.id);
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Employee Not Found',
                    text: 'No employee found matching your search criteria in payroll data.'
                });
            }
        }

        function showSearchResults(count, type) {
            // Remove existing search result display
            hideSearchResults();
            
            const searchInfo = document.createElement('div');
            searchInfo.id = 'searchResults';
            searchInfo.className = 'bg-blue-100 dark:bg-blue-900 border border-blue-300 dark:border-blue-700 text-blue-800 dark:text-blue-200 px-4 py-2 rounded-lg mb-4';
            searchInfo.innerHTML = `<i class="fas fa-search mr-2"></i>Found ${count} ${type === 'attendance' ? 'employees' : 'payroll records'} matching your search`;
            
            const targetContainer = type === 'attendance' ? 
                document.querySelector('#content-attendance .attendance-table-container') :
                document.querySelector('#content-payroll .overflow-x-auto');
            
            targetContainer.parentNode.insertBefore(searchInfo, targetContainer);
        }

        function hideSearchResults() {
            const existingResults = document.getElementById('searchResults');
            if (existingResults) {
                existingResults.remove();
            }
        }

        // Month Change Function
        function changeMonth() {
            currentMonth = document.getElementById('monthSelector').value;
            
            // Initialize attendance for new month if not exists
            if (!attendance[currentMonth]) {
                attendance[currentMonth] = {};
                employees.forEach(emp => {
                    if (emp.status === 'Active') {
                        attendance[currentMonth][emp.id] = generateMonthlyAttendance();
                    }
                });
            }
            
            // Reset payroll data
            payrollData = [];
            
            // Update all views
            updateDashboard();
            displayAttendance();
            displayPayroll();
            
            addActivity('Changed month to ' + currentMonth);
            saveToLocalStorage();
        }

        // Save Monthly Payroll
        function saveMonthlyPayroll() {
            if (payrollData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Payroll Data',
                    text: 'Please process payroll first before saving.'
                });
                return;
            }
            
            const monthlyData = {
                month: currentMonth,
                employees: employees.slice(),
                attendance: JSON.parse(JSON.stringify(attendance[currentMonth])),
                payroll: payrollData.slice(),
                savedAt: new Date().toISOString()
            };
            
            // Save to localStorage with month key
            localStorage.setItem(`payroll_${currentMonth}`, JSON.stringify(monthlyData));
            
            Swal.fire({
                icon: 'success',
                title: 'Month Saved!',
                text: `Payroll data for ${currentMonth} has been saved.`,
                timer: 2000,
                showConfirmButton: false
            });
            
            addActivity(`Saved payroll data for ${currentMonth}`);
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S - Save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveToLocalStorage();
                    Swal.fire({
                        icon: 'success',
                        title: 'Saved!',
                        text: 'All data has been saved.',
                        timer: 1000,
                        showConfirmButton: false
                    });
                }
                
                // Ctrl/Cmd + P - Process Payroll
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    processPayroll();
                }
                
                // Ctrl/Cmd + E - Export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportAllData();
                }
                
                // ESC - Close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-backdrop:not(.hidden)').forEach(modal => {
                        modal.classList.add('hidden');
                    });
                }
            });
        }

        // Data Integrity Check
        function checkDataIntegrity() {
            let issues = [];
            
            // Check for duplicate employee IDs
            const ids = employees.map(emp => emp.id);
            const duplicates = ids.filter((id, index) => ids.indexOf(id) !== index);
            if (duplicates.length > 0) {
                issues.push(`Duplicate employee IDs found: ${duplicates.join(', ')}`);
            }
            
            // Check for missing attendance data
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            activeEmployees.forEach(emp => {
                if (!attendance[currentMonth]?.[emp.id]) {
                    issues.push(`Missing attendance data for ${emp.name}`);
                }
            });
            
            // Check for invalid salary data
            employees.forEach(emp => {
                if (emp.basicSalary <= 0) {
                    issues.push(`Invalid salary for ${emp.name}`);
                }
            });
            
            if (issues.length > 0) {
                console.warn('Data integrity issues found:', issues);
                addActivity('Data integrity check: ' + issues.length + ' issues found');
            }
        }

        // Window resize handler
        window.addEventListener('resize', function() {
            // Update charts on resize
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.resize();
            });
        });

        // Before unload warning
        window.addEventListener('beforeunload', function(e) {
            const lastSaved = localStorage.getItem('payrollSystemData');
            const currentData = JSON.stringify({
                employees: employees,
                attendance: attendance,
                payrollData: payrollData
            });
            
            if (!lastSaved || lastSaved !== currentData) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>