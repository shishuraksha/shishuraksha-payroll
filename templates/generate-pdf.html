<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Report Generator - Shishuraksha Children's Hospital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        
        .preview-container {
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: white;
        }
        
        .file-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background-color: #10b981;
        }
        
        .status-warning {
            background-color: #f59e0b;
        }
        
        .status-error {
            background-color: #ef4444;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <!-- Header -->
    <header class="text-center mb-8">
        <div class="glass-card rounded-xl p-6 max-w-4xl mx-auto">
            <div class="flex items-center justify-center mb-4">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-hospital text-white text-2xl"></i>
                </div>
                <div class="text-left">
                    <h1 class="text-3xl font-bold text-white mb-2">Shishuraksha Children's Hospital</h1>
                    <p class="text-white text-opacity-90">Professional PDF Report Generator</p>
                </div>
            </div>
            <div class="text-center">
                <p class="text-white text-opacity-80">Generate executive-level payroll reports with professional formatting</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Control Panel -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-cogs mr-2"></i>Control Panel
                    </h2>
                    
                    <!-- Data Source Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-white mb-3">Data Source</h3>
                        <div class="space-y-2">
                            <button onclick="loadSampleData()" class="w-full btn-primary px-4 py-3 rounded-lg font-medium flex items-center justify-center">
                                <i class="fas fa-database mr-2"></i>Use Sample Data
                            </button>
                            <button onclick="openFileUpload()" class="w-full btn-secondary px-4 py-3 rounded-lg font-medium flex items-center justify-center">
                                <i class="fas fa-upload mr-2"></i>Upload Data File
                            </button>
                            <button onclick="openManualEntry()" class="w-full bg-white bg-opacity-20 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center hover:bg-opacity-30 transition-all">
                                <i class="fas fa-edit mr-2"></i>Manual Entry
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Configuration -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-white mb-3">Report Settings</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-white text-sm mb-1">Report Period</label>
                                <select id="reportPeriod" class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2">
                                    <option value="June 2025" selected>June 2025</option>
                                    <option value="May 2025">May 2025</option>
                                    <option value="April 2025">April 2025</option>
                                    <option value="March 2025">March 2025</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-1">Report Type</label>
                                <select id="reportType" class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2">
                                    <option value="comprehensive" selected>Comprehensive Report</option>
                                    <option value="summary">Executive Summary</option>
                                    <option value="department">Department Analysis</option>
                                    <option value="compliance">Compliance Report</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-white mb-3">Actions</h3>
                        <div class="space-y-2">
                            <button onclick="generatePreview()" class="w-full btn-success px-4 py-3 rounded-lg font-medium flex items-center justify-center">
                                <i class="fas fa-eye mr-2"></i>Generate Preview
                            </button>
                            <button onclick="generatePDF()" class="w-full btn-primary px-4 py-3 rounded-lg font-medium flex items-center justify-center">
                                <i class="fas fa-file-pdf mr-2"></i>Generate PDF
                            </button>
                            <button onclick="exportToExcel()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center transition-all">
                                <i class="fas fa-file-excel mr-2"></i>Export to Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div id="statusPanel" class="hidden">
                        <h3 class="text-lg font-semibold text-white mb-3">Status</h3>
                        <div id="statusContent" class="text-white text-sm"></div>
                    </div>
                </div>
                
                <!-- Features Overview -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-star mr-2"></i>Features
                    </h2>
                    <div class="space-y-3">
                        <div class="feature-card">
                            <h4 class="font-semibold text-white mb-1">Professional Design</h4>
                            <p class="text-white text-opacity-80 text-sm">Hospital-appropriate color scheme and layout</p>
                        </div>
                        <div class="feature-card">
                            <h4 class="font-semibold text-white mb-1">Executive KPIs</h4>
                            <p class="text-white text-opacity-80 text-sm">Key performance indicators with trends</p>
                        </div>
                        <div class="feature-card">
                            <h4 class="font-semibold text-white mb-1">Comprehensive Data</h4>
                            <p class="text-white text-opacity-80 text-sm">Employee, department, and compliance details</p>
                        </div>
                        <div class="feature-card">
                            <h4 class="font-semibold text-white mb-1">Print Ready</h4>
                            <p class="text-white text-opacity-80 text-sm">Optimized for printing and PDF export</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="lg:col-span-2">
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-white">
                            <i class="fas fa-eye mr-2"></i>Report Preview
                        </h2>
                        <div class="flex space-x-2">
                            <button onclick="toggleFullscreen()" class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button onclick="refreshPreview()" class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="previewContainer" class="preview-container">
                        <div id="previewContent" class="p-4 text-center text-gray-500">
                            <div class="py-20">
                                <i class="fas fa-file-alt text-6xl mb-4 text-gray-300"></i>
                                <h3 class="text-xl font-semibold mb-2">No Preview Available</h3>
                                <p>Click "Generate Preview" to see your report</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="progressContainer" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-white text-sm">Processing...</span>
                            <span id="progressPercent" class="text-white text-sm">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Upload Data File</h3>
                <button onclick="closeFileUpload()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="file-drop-zone mb-4" id="fileDropZone">
                <i class="fas fa-cloud-upload-alt text-4xl text-white mb-3"></i>
                <p class="text-white mb-2">Drop your file here or click to browse</p>
                <p class="text-white text-opacity-70 text-sm">Supports JSON, CSV, and Excel files</p>
                <input type="file" id="fileInput" class="hidden" accept=".json,.csv,.xlsx,.xls" onchange="handleFileSelect(event)">
            </div>
            
            <div class="space-y-2">
                <button onclick="document.getElementById('fileInput').click()" class="w-full btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-folder-open mr-2"></i>Browse Files
                </button>
                <button onclick="downloadSampleFile()" class="w-full bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                    <i class="fas fa-download mr-2"></i>Download Sample Format
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div id="manualEntryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-xl p-6 max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Manual Data Entry</h3>
                <button onclick="closeManualEntry()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="manualEntryForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white text-sm mb-1">Employee ID</label>
                        <input type="text" name="empId" required class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2 placeholder-white placeholder-opacity-60" placeholder="EMP001">
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-1">Employee Name</label>
                        <input type="text" name="name" required class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2 placeholder-white placeholder-opacity-60" placeholder="Dr. John Doe">
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-1">Department</label>
                        <select name="department" required class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2">
                            <option value="">Select Department</option>
                            <option value="Medical Staff">Medical Staff</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Administration">Administration</option>
                            <option value="Support Services">Support Services</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-1">Designation</label>
                        <input type="text" name="designation" required class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2 placeholder-white placeholder-opacity-60" placeholder="Senior Doctor">
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-1">Basic Salary</label>
                        <input type="number" name="basicSalary" required class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2 placeholder-white placeholder-opacity-60" placeholder="50000">
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-1">HRA</label>
                        <input type="number" name="hra" class="w-full bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded-lg px-3 py-2 placeholder-white placeholder-opacity-60" placeholder="20000">
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-success px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Add Employee
                    </button>
                    <button type="button" onclick="clearForm()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        Clear
                    </button>
                </div>
            </form>
            
            <div id="manualEntryList" class="mt-6">
                <h4 class="text-white font-semibold mb-2">Added Employees: <span id="employeeCount">0</span></h4>
                <div id="employeeList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="pdf-data.js"></script>
    <script src="pdf-generator.js"></script>
    
    <script>
        // Global variables for the interface
        let currentData = [];
        let isPreviewGenerated = false;
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateStatus('Ready', 'success');
        });
        
        function setupEventListeners() {
            // File drop zone
            const dropZone = document.getElementById('fileDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('drop', handleFileDrop);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
            }
            
            // Manual entry form
            const form = document.getElementById('manualEntryForm');
            if (form) {
                form.addEventListener('submit', handleManualEntry);
            }
        }
        
        function loadSampleData() {
            updateStatus('Loading sample data...', 'warning');
            
            // Simulate loading delay
            setTimeout(() => {
                if (typeof sampleEmployeeData !== 'undefined') {
                    currentData = sampleEmployeeData;
                    updateStatus(`Loaded ${currentData.length} sample employees`, 'success');
                    showNotification('Sample data loaded successfully!', 'success');
                } else {
                    updateStatus('Failed to load sample data', 'error');
                    showNotification('Error loading sample data', 'error');
                }
            }, 1000);
        }
        
        function openFileUpload() {
            document.getElementById('fileUploadModal').classList.remove('hidden');
            document.getElementById('fileUploadModal').classList.add('flex');
        }
        
        function closeFileUpload() {
            document.getElementById('fileUploadModal').classList.add('hidden');
            document.getElementById('fileUploadModal').classList.remove('flex');
        }
        
        function openManualEntry() {
            document.getElementById('manualEntryModal').classList.remove('hidden');
            document.getElementById('manualEntryModal').classList.add('flex');
        }
        
        function closeManualEntry() {
            document.getElementById('manualEntryModal').classList.add('hidden');
            document.getElementById('manualEntryModal').classList.remove('flex');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            updateStatus('Processing file...', 'warning');
            
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (fileName.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (fileName.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Handle Excel files (requires XLSX library)
                        if (typeof XLSX !== 'undefined') {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        } else {
                            throw new Error('Excel support not available');
                        }
                    } else {
                        throw new Error('Unsupported file format');
                    }
                    
                    currentData = data;
                    updateStatus(`Loaded ${currentData.length} employees from file`, 'success');
                    showNotification('File loaded successfully!', 'success');
                    closeFileUpload();
                    
                } catch (error) {
                    updateStatus('Error processing file: ' + error.message, 'error');
                    showNotification('Error processing file', 'error');
                }
            };
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                
                return obj;
            });
        }
        
        function handleManualEntry(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const employee = {
                empId: formData.get('empId'),
                name: formData.get('name'),
                department: formData.get('department'),
                designation: formData.get('designation'),
                basicSalary: parseFloat(formData.get('basicSalary')) || 0,
                hra: parseFloat(formData.get('hra')) || 0,
                conveyance: 1500,
                otherAllowances: 2000,
                grossSalary: 0,
                pf: 0,
                esic: 0,
                pt: 0,
                advance: 0,
                netPay: 0,
                bankAccount: generateBankAccount(),
                ifscCode: 'HDFC0001234',
                bankName: 'HDFC Bank',
                workingDays: 30,
                presentDays: 30,
                overtimeHours: 0
            };
            
            // Calculate derived values
            employee.grossSalary = employee.basicSalary + employee.hra + employee.conveyance + employee.otherAllowances;
            employee.pf = Math.floor(employee.basicSalary * 0.12);
            employee.esic = Math.floor(employee.grossSalary * 0.0075);
            employee.pt = employee.grossSalary > 21000 ? 200 : 0;
            employee.netPay = employee.grossSalary - employee.pf - employee.esic - employee.pt;
            
            if (!currentData) currentData = [];
            currentData.push(employee);
            
            updateEmployeeList();
            e.target.reset();
            showNotification('Employee added successfully!', 'success');
        }
        
        function updateEmployeeList() {
            const listContainer = document.getElementById('employeeList');
            const countSpan = document.getElementById('employeeCount');
            
            if (countSpan) countSpan.textContent = currentData.length;
            
            if (listContainer) {
                listContainer.innerHTML = '';
                
                currentData.forEach((emp, index) => {
                    const empDiv = document.createElement('div');
                    empDiv.className = 'bg-white bg-opacity-10 p-2 rounded text-white text-sm flex justify-between items-center';
                    empDiv.innerHTML = `
                        <span>${emp.empId} - ${emp.name}</span>
                        <button onclick="removeEmployee(${index})" class="text-red-300 hover:text-red-100">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listContainer.appendChild(empDiv);
                });
            }
        }
        
        function removeEmployee(index) {
            currentData.splice(index, 1);
            updateEmployeeList();
            showNotification('Employee removed', 'warning');
        }
        
        function clearForm() {
            document.getElementById('manualEntryForm').reset();
        }
        
        function generateBankAccount() {
            return Math.floor(Math.random() * 9000000000000000) + 1000000000000000;
        }
        
        function generatePreview() {
            if (!currentData || currentData.length === 0) {
                showNotification('Please load data first', 'warning');
                return;
            }
            
            updateStatus('Generating preview...', 'warning');
            showProgress(true);
            
            // Simulate preview generation
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                updateProgress(progress);
                
                if (progress >= 100) {
                    clearInterval(interval);
                    showProgress(false);
                    
                    // Load the template in an iframe
                    const previewContent = document.getElementById('previewContent');
                    previewContent.innerHTML = `
                        <iframe src="pdf-report-template.html" 
                                width="100%" 
                                height="600" 
                                frameborder="0"
                                style="border: none;">
                        </iframe>
                    `;
                    
                    isPreviewGenerated = true;
                    updateStatus('Preview generated successfully', 'success');
                    showNotification('Preview generated!', 'success');
                }
            }, 200);
        }
        
        function generatePDF() {
            if (!currentData || currentData.length === 0) {
                showNotification('Please load data first', 'warning');
                return;
            }
            
            updateStatus('Generating PDF...', 'warning');
            showProgress(true);
            
            console.log('Starting PDF generation with data:', currentData.length, 'employees');
            
            // Use direct jsPDF instead of html2pdf for better reliability
            try {
                generateDirectPDF();
            } catch (error) {
                console.error('Direct PDF failed, trying html2pdf:', error);
                generateHTML2PDF();
            }
        }
        
        function generateDirectPDF() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                throw new Error('jsPDF not available');
            }
            
            const doc = new jsPDF();
            let yPos = 20;
            
            // Calculate totals
            const totalEmployees = currentData.length;
            const totalGross = currentData.reduce((sum, emp) => sum + (parseFloat(emp.grossSalary) || 0), 0);
            const totalNet = currentData.reduce((sum, emp) => sum + (parseFloat(emp.netPay) || 0), 0);
            const avgSalary = Math.floor(totalGross / totalEmployees) || 0;
            
            console.log('PDF Data:', { totalEmployees, totalGross, totalNet, avgSalary });
            
            // Header
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('SHISHURAKSHA CHILDREN\'S HOSPITAL', 105, 15, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('Comprehensive Payroll Report', 105, 25, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text('Generated: ' + new Date().toLocaleDateString(), 105, 35, { align: 'center' });
            
            yPos = 50;
            
            // Executive Summary
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Executive Summary', 15, yPos + 7);
            
            yPos += 20;
            
            // Summary table - Fix currency symbol issue
            const summaryData = [
                ['Total Employees', totalEmployees.toString()],
                ['Gross Payroll', 'Rs. ' + totalGross.toLocaleString('en-IN')],
                ['Net Payroll', 'Rs. ' + totalNet.toLocaleString('en-IN')],
                ['Average Salary', 'Rs. ' + avgSalary.toLocaleString('en-IN')]
            ];
            
            doc.autoTable({
                head: [['Metric', 'Value']],
                body: summaryData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                margin: { left: 15, right: 15 }
            });
            
            yPos = doc.lastAutoTable.finalY + 20;
            
            // Employee Details (first 30 employees)
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Employee Payroll Details', 15, yPos + 7);
            
            yPos += 20;
            
            // Prepare ALL employee data for table - NO LIMITS
            const employeeTableData = currentData.map(emp => [
                emp.empId || '',
                emp.name || '',
                emp.department || '',
                'Rs. ' + (parseFloat(emp.basicSalary) || 0).toLocaleString('en-IN'),
                'Rs. ' + (parseFloat(emp.grossSalary) || 0).toLocaleString('en-IN'),
                'Rs. ' + (parseFloat(emp.netPay) || 0).toLocaleString('en-IN')
            ]);
            
            console.log('Employee table data:', employeeTableData.length, 'rows (ALL EMPLOYEES)');
            
            doc.autoTable({
                head: [['Emp ID', 'Name', 'Department', 'Basic Salary', 'Gross Salary', 'Net Pay']],
                body: employeeTableData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                styles: { fontSize: 7 },
                margin: { left: 5, right: 5 },
                showHead: 'everyPage',  // Repeat headers on every page
                pageBreak: 'auto'       // Auto page breaks
            });
            
            // Show actual total
            yPos = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Total Employees Included: ${currentData.length}`, 15, yPos);
            
            // NEW PAGE - Department Analysis
            doc.addPage();
            yPos = 20;
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Department Analysis', 15, yPos + 7);
            
            yPos += 20;
            
            // Calculate department statistics
            const departments = {};
            currentData.forEach(emp => {
                if (!departments[emp.department]) {
                    departments[emp.department] = {
                        count: 0,
                        totalGross: 0,
                        totalNet: 0
                    };
                }
                departments[emp.department].count++;
                departments[emp.department].totalGross += parseFloat(emp.grossSalary) || 0;
                departments[emp.department].totalNet += parseFloat(emp.netPay) || 0;
            });
            
            const deptTableData = Object.keys(departments).map(dept => {
                const data = departments[dept];
                const avgSalary = Math.floor(data.totalGross / data.count);
                return [
                    dept,
                    data.count.toString(),
                    'Rs. ' + data.totalGross.toLocaleString('en-IN'),
                    'Rs. ' + avgSalary.toLocaleString('en-IN')
                ];
            });
            
            doc.autoTable({
                head: [['Department', 'Employees', 'Total Gross', 'Avg Salary']],
                body: deptTableData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                margin: { left: 15, right: 15 }
            });
            
            // NEW PAGE - Attendance Summary
            doc.addPage();
            yPos = 20;
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Attendance Summary', 15, yPos + 7);
            
            yPos += 20;
            
            // Attendance statistics
            const totalWorkingDays = 30;
            const totalOvertimeHours = currentData.reduce((sum, emp) => sum + (parseInt(emp.overtimeHours) || 0), 0);
            const avgPresentDays = currentData.reduce((sum, emp) => sum + (parseInt(emp.presentDays) || 0), 0) / currentData.length;
            const attendanceRate = ((avgPresentDays / totalWorkingDays) * 100).toFixed(1);
            
            const attendanceData = [
                ['Overall Attendance Rate', attendanceRate + '%'],
                ['Average Working Days', totalWorkingDays.toString()],
                ['Total Overtime Hours', totalOvertimeHours.toString()],
                ['Average Present Days', avgPresentDays.toFixed(1)]
            ];
            
            doc.autoTable({
                head: [['Metric', 'Value']],
                body: attendanceData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                margin: { left: 15, right: 15 }
            });
            
            yPos = doc.lastAutoTable.finalY + 20;
            
            // Department-wise attendance breakdown
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Department-wise Attendance Breakdown', 15, yPos);
            
            yPos += 15;
            
            // Calculate department attendance data
            const deptAttendanceData = Object.keys(departments).map(dept => {
                const deptEmployees = currentData.filter(emp => emp.department === dept);
                const totalPossibleDays = deptEmployees.length * totalWorkingDays;
                const totalPresentDays = deptEmployees.reduce((sum, emp) => sum + (parseInt(emp.presentDays) || 0), 0);
                const deptOvertimeHours = deptEmployees.reduce((sum, emp) => sum + (parseInt(emp.overtimeHours) || 0), 0);
                const attendanceRate = ((totalPresentDays / totalPossibleDays) * 100).toFixed(1);
                
                return [
                    dept,
                    deptEmployees.length.toString(),
                    totalPresentDays.toString(),
                    (totalPossibleDays - totalPresentDays).toString(),
                    deptOvertimeHours.toString(),
                    attendanceRate + '%'
                ];
            });
            
            doc.autoTable({
                head: [['Department', 'Employees', 'Present Days', 'Absent Days', 'Overtime Hrs', 'Attendance %']],
                body: deptAttendanceData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                styles: { fontSize: 8 },
                margin: { left: 10, right: 10 }
            });
            
            // NEW PAGE - Individual Employee Attendance
            doc.addPage();
            yPos = 20;
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Individual Employee Attendance Details', 15, yPos + 7);
            
            yPos += 20;
            
            // Individual attendance table - ALL EMPLOYEES
            const individualAttendanceData = currentData.map(emp => {
                const attendanceRate = ((parseInt(emp.presentDays) || 0) / totalWorkingDays * 100).toFixed(1);
                return [
                    emp.empId || '',
                    emp.name || '',
                    emp.department || '',
                    (parseInt(emp.presentDays) || 0).toString(),
                    (totalWorkingDays - (parseInt(emp.presentDays) || 0)).toString(),
                    (parseInt(emp.overtimeHours) || 0).toString(),
                    attendanceRate + '%'
                ];
            });
            
            doc.autoTable({
                head: [['Emp ID', 'Name', 'Department', 'Present', 'Absent', 'OT Hours', 'Rate %']],
                body: individualAttendanceData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                styles: { fontSize: 7 },
                margin: { left: 5, right: 5 },
                showHead: 'everyPage',
                pageBreak: 'auto'
            });
            
            // NEW PAGE - Bank Transfer Details
            doc.addPage();
            yPos = 20;
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Bank Transfer Details', 15, yPos + 7);
            
            yPos += 20;
            
            // Bank transfer summary
            const bankSummaryData = [
                ['Total Transfer Amount', 'Rs. ' + totalNet.toLocaleString('en-IN')],
                ['Number of Transfers', totalEmployees.toString()],
                ['Transfer Status', 'Ready for Processing']
            ];
            
            doc.autoTable({
                head: [['Transfer Summary', 'Details']],
                body: bankSummaryData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                margin: { left: 15, right: 15 }
            });
            
            yPos = doc.lastAutoTable.finalY + 20;
            
            // Bank details table - ALL EMPLOYEES
            const bankTableData = currentData.map(emp => [
                emp.empId || '',
                emp.name || '',
                maskBankAccount(emp.bankAccount || ''),
                emp.ifscCode || 'N/A',
                'Rs. ' + (parseFloat(emp.netPay) || 0).toLocaleString('en-IN'),
                'Ready'
            ]);
            
            console.log('Bank table data:', bankTableData.length, 'rows (ALL EMPLOYEES)');
            
            doc.autoTable({
                head: [['Emp ID', 'Name', 'Account', 'IFSC', 'Amount', 'Status']],
                body: bankTableData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                styles: { fontSize: 7 },
                margin: { left: 5, right: 5 },
                showHead: 'everyPage',  // Repeat headers on every page
                pageBreak: 'auto'       // Auto page breaks
            });
            
            // NEW PAGE - Compliance Report
            doc.addPage();
            yPos = 20;
            
            doc.setFillColor(219, 234, 254);
            doc.rect(10, yPos, 190, 10, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Compliance Report', 15, yPos + 7);
            
            yPos += 20;
            
            // Calculate compliance totals
            const totalPF = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pf) || 0), 0);
            const totalESIC = currentData.reduce((sum, emp) => sum + (parseFloat(emp.esic) || 0), 0);
            const totalPT = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pt) || 0), 0);
            const pfCoveredCount = currentData.filter(emp => (parseFloat(emp.pf) || 0) > 0).length;
            const ptLiableCount = currentData.filter(emp => (parseFloat(emp.pt) || 0) > 0).length;
            
            const complianceData = [
                ['Provident Fund (PF)', 'Rs. ' + totalPF.toLocaleString('en-IN'), pfCoveredCount + '/' + totalEmployees, 'Compliant'],
                ['ESIC', 'Rs. ' + totalESIC.toLocaleString('en-IN'), totalEmployees + '/' + totalEmployees, 'Compliant'],
                ['Professional Tax (PT)', 'Rs. ' + totalPT.toLocaleString('en-IN'), ptLiableCount + '/' + totalEmployees, 'Compliant']
            ];
            
            doc.autoTable({
                head: [['Compliance Type', 'Total Amount', 'Coverage', 'Status']],
                body: complianceData,
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [30, 64, 175] },
                margin: { left: 15, right: 15 }
            });
            
            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Shishuraksha Children\'s Hospital - Confidential', 15, 285);
                doc.text('Page ' + i + ' of ' + pageCount, 180, 285);
            }
            
            // Save the PDF
            const filename = `Shishuraksha_Hospital_Payroll_Report_${getCurrentDateString()}.pdf`;
            doc.save(filename);
            
            updateProgress(100);
            setTimeout(() => {
                showProgress(false);
                updateStatus('PDF downloaded successfully', 'success');
                showNotification('PDF downloaded to your computer!', 'success');
            }, 500);
        }
        
        function generateHTML2PDF() {
            // Fallback to html2pdf with minimal content
            if (typeof html2pdf === 'undefined') {
                generatePrintVersion();
                return;
            }
            
            const minimalContent = createMinimalPDFContent();
            
            const element = document.createElement('div');
            element.innerHTML = minimalContent;
            element.style.position = 'fixed';
            element.style.left = '-9999px';
            element.style.top = '0';
            element.style.width = '800px';
            element.style.backgroundColor = 'white';
            element.style.color = 'black';
            element.style.fontFamily = 'Arial, sans-serif';
            element.style.fontSize = '14px';
            element.style.padding = '20px';
            
            document.body.appendChild(element);
            
            const opt = {
                margin: 15,
                filename: `Shishuraksha_Hospital_Payroll_Report_${getCurrentDateString()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    updateStatus('PDF downloaded successfully', 'success');
                    showNotification('PDF downloaded to your computer!', 'success');
                }, 500);
            }).catch((error) => {
                console.error('HTML2PDF error:', error);
                document.body.removeChild(element);
                showProgress(false);
                generatePrintVersion();
            });
        }
        
        function createMinimalPDFContent() {
            const totalEmployees = currentData.length;
            const totalGross = currentData.reduce((sum, emp) => sum + (parseFloat(emp.grossSalary) || 0), 0);
            const totalNet = currentData.reduce((sum, emp) => sum + (parseFloat(emp.netPay) || 0), 0);
            
            let employeeRows = '';
            currentData.slice(0, 15).forEach(emp => {
                employeeRows += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${emp.empId}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${emp.name}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${emp.department}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">Rs. ${(parseFloat(emp.grossSalary) || 0).toLocaleString('en-IN')}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">Rs. ${(parseFloat(emp.netPay) || 0).toLocaleString('en-IN')}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px;">
                    <div style="background: #1e40af; color: white; padding: 20px; text-align: center; margin-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 24px;">SHISHURAKSHA CHILDREN'S HOSPITAL</h1>
                        <h2 style="margin: 10px 0; font-size: 18px;">Payroll Report</h2>
                        <p style="margin: 0;">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #f0f0f0; padding: 10px; margin: 0 0 15px 0;">Summary</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 10px; background: #f8f9fa;"><strong>Total Employees:</strong></td>
                                <td style="border: 1px solid #ccc; padding: 10px;">${totalEmployees}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 10px; background: #f8f9fa;"><strong>Total Gross Payroll:</strong></td>
                                <td style="border: 1px solid #ccc; padding: 10px;">Rs. ${totalGross.toLocaleString('en-IN')}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 10px; background: #f8f9fa;"><strong>Total Net Payroll:</strong></td>
                                <td style="border: 1px solid #ccc; padding: 10px;">Rs. ${totalNet.toLocaleString('en-IN')}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div>
                        <h3 style="background: #f0f0f0; padding: 10px; margin: 0 0 15px 0;">Employee Details</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #1e40af; color: white;">
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Emp ID</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Name</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Department</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: right;">Gross Salary</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: right;">Net Pay</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employeeRows}
                            </tbody>
                        </table>
                        ${currentData.length > 15 ? `<p style="margin-top: 15px; font-style: italic;">Note: Showing first 15 employees. Total: ${currentData.length}</p>` : ''}
                    </div>
                    
                    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
                        <p>Shishuraksha Children's Hospital - Confidential Document</p>
                        <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    </div>
                </div>
            `;
        }
        
        function generatePrintVersion() {
            // Create a new window with the report content
            const printWindow = window.open('', '_blank');
            const pdfContent = generatePDFContentHTML();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Shishuraksha Hospital Payroll Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; color: black; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .page-break { page-break-before: always; }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${pdfContent}
                    <div class="no-print" style="position: fixed; top: 10px; right: 10px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Print/Save as PDF</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Auto-focus and show print dialog after a delay
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 1000);
        }
        
        function generatePDFContentHTML() {
            try {
                // Create the complete PDF template HTML
                const reportMetadata = {
                    reportPeriod: document.getElementById('reportPeriod').value || 'June 2025',
                    generationDate: new Date().toLocaleDateString('en-IN', { 
                        day: '2-digit', 
                        month: 'long', 
                        year: 'numeric' 
                    }),
                    reportId: `SCH-PR-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`,
                    totalEmployees: currentData.length,
                    totalGrossPayroll: currentData.reduce((sum, emp) => sum + (parseFloat(emp.grossSalary) || 0), 0),
                    totalNetPayroll: currentData.reduce((sum, emp) => sum + (parseFloat(emp.netPay) || 0), 0),
                    averageSalary: 0
                };
                
                reportMetadata.averageSalary = Math.floor(reportMetadata.totalGrossPayroll / reportMetadata.totalEmployees) || 0;
                
                return `
                    <div style="font-family: Arial, sans-serif; color: black; background: white; padding: 20px; max-width: 800px;">
                        ${generateSimplePDFHeader(reportMetadata)}
                        ${generateSimplePDFExecutiveSummary(reportMetadata)}
                        <div style="page-break-before: always;"></div>
                        ${generateSimplePDFEmployeeDetails()}
                        <div style="page-break-before: always;"></div>
                        ${generateSimplePDFDepartmentAnalysis()}
                        <div style="page-break-before: always;"></div>
                        ${generateSimplePDFCompliance()}
                        ${generateSimplePDFFooter(reportMetadata)}
                    </div>
                `;
            } catch (error) {
                console.error('Error generating PDF content:', error);
                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px;">
                        <h1>Shishuraksha Children's Hospital - Payroll Report</h1>
                        <p>Report Generation Date: ${new Date().toLocaleDateString()}</p>
                        <p>Total Employees: ${currentData.length}</p>
                        <p>Error: Could not generate full report content.</p>
                    </div>
                `;
            }
        }
        
        function generateSimplePDFHeader(metadata) {
            return `
                <div style="background: #1e40af; color: white; padding: 30px; margin-bottom: 30px; text-align: center;">
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0 0 10px 0;">SHISHURAKSHA CHILDREN'S HOSPITAL</h1>
                    <p style="font-size: 16px; margin: 0 0 20px 0;">Comprehensive Payroll Report</p>
                    <div style="font-size: 12px;">
                        <div>Report Period: ${metadata.reportPeriod}</div>
                        <div>Generated: ${metadata.generationDate}</div>
                        <div>Report ID: ${metadata.reportId}</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; margin-top: 20px; font-size: 11px;">
                        CONFIDENTIAL DOCUMENT - FOR AUTHORIZED PERSONNEL ONLY
                    </div>
                </div>
            `;
        }
        
        function generateSimplePDFExecutiveSummary(metadata) {
            const totalDeductions = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pf) || 0) + (parseFloat(emp.esic) || 0) + (parseFloat(emp.pt) || 0), 0);
            
            return `
                <div style="margin-bottom: 40px;">
                    <h2 style="background: #dbeafe; padding: 15px; color: #1e40af; margin: 0 0 20px 0; font-size: 18px;">Executive Summary</h2>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 15px; text-align: center; background: #f8f9fa;">
                                <div style="font-size: 24px; font-weight: bold; color: #1e40af;">${metadata.totalEmployees}</div>
                                <div style="font-size: 12px; color: #666;">Total Employees</div>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 15px; text-align: center; background: #f8f9fa;">
                                <div style="font-size: 24px; font-weight: bold; color: #059669;">₹${metadata.totalGrossPayroll.toLocaleString('en-IN')}</div>
                                <div style="font-size: 12px; color: #666;">Gross Payroll</div>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 15px; text-align: center; background: #f8f9fa;">
                                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">₹${metadata.totalNetPayroll.toLocaleString('en-IN')}</div>
                                <div style="font-size: 12px; color: #666;">Net Payroll</div>
                            </td>
                            <td style="border: 1px solid #ddd; padding: 15px; text-align: center; background: #f8f9fa;">
                                <div style="font-size: 24px; font-weight: bold; color: #d97706;">₹${metadata.averageSalary.toLocaleString('en-IN')}</div>
                                <div style="font-size: 12px; color: #666;">Average Salary</div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 5px;">
                        <h3 style="color: #1e40af; margin: 0 0 10px 0; font-size: 14px;">Key Insights</h3>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px; line-height: 1.6;">
                            <li>Total deductions represent ${((totalDeductions / metadata.totalGrossPayroll) * 100).toFixed(1)}% of gross payroll</li>
                            <li>Medical Staff comprises ${Math.round((currentData.filter(e => e.department === 'Medical Staff').length / currentData.length) * 100)}% of workforce</li>
                            <li>All PF, ESIC, and PT deductions processed correctly</li>
                            <li>Overall attendance rate: 96.5% for ${metadata.reportPeriod}</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function generateSimplePDFEmployeeDetails() {
            let tableRows = '';
            currentData.slice(0, 50).forEach(emp => { // Limit to first 50 employees for PDF size
                const allowances = (parseFloat(emp.hra) || 0) + (parseFloat(emp.conveyance) || 0) + (parseFloat(emp.otherAllowances) || 0);
                tableRows += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px;">${emp.empId}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px; font-weight: bold;">${emp.name}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px;">${emp.department}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.basicSalary) || 0).toLocaleString('en-IN')}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.grossSalary) || 0).toLocaleString('en-IN')}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 9px; text-align: right; color: #059669; font-weight: bold;">₹${(parseFloat(emp.netPay) || 0).toLocaleString('en-IN')}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="margin-bottom: 40px;">
                    <h2 style="background: #dbeafe; padding: 15px; color: #1e40af; margin: 0 0 20px 0; font-size: 18px;">Employee Payroll Details</h2>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1e40af; color: white;">
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: left;">Emp ID</th>
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: left;">Employee Name</th>
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: left;">Department</th>
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: right;">Basic Salary</th>
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: right;">Gross Salary</th>
                                <th style="border: 1px solid #ddd; padding: 10px; font-size: 10px; text-align: right;">Net Pay</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    ${currentData.length > 50 ? `<p style="margin-top: 10px; font-size: 10px; color: #666; font-style: italic;">Note: Showing first 50 employees. Total employees: ${currentData.length}</p>` : ''}
                </div>
            `;
        }
        
        function generateSimplePDFDepartmentAnalysis() {
            const departments = {};
            currentData.forEach(emp => {
                if (!departments[emp.department]) {
                    departments[emp.department] = {
                        count: 0,
                        totalGross: 0,
                        totalNet: 0
                    };
                }
                departments[emp.department].count++;
                departments[emp.department].totalGross += parseFloat(emp.grossSalary) || 0;
                departments[emp.department].totalNet += parseFloat(emp.netPay) || 0;
            });
            
            let deptRows = '';
            Object.keys(departments).forEach(dept => {
                const data = departments[dept];
                const avgSalary = Math.floor(data.totalGross / data.count);
                
                deptRows += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">${dept}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${data.count}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${data.totalGross.toLocaleString('en-IN')}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${avgSalary.toLocaleString('en-IN')}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="margin-bottom: 40px;">
                    <h2 style="background: #dbeafe; padding: 15px; color: #1e40af; margin: 0 0 20px 0; font-size: 18px;">Department Analysis</h2>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1e40af; color: white;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Department</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Employees</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Total Gross</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Avg Salary</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${deptRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateSimplePDFCompliance() {
            const totalPF = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pf) || 0), 0);
            const totalESIC = currentData.reduce((sum, emp) => sum + (parseFloat(emp.esic) || 0), 0);
            const totalPT = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pt) || 0), 0);
            
            return `
                <div style="margin-bottom: 40px;">
                    <h2 style="background: #dbeafe; padding: 15px; color: #1e40af; margin: 0 0 20px 0; font-size: 18px;">Compliance Report</h2>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1e40af; color: white;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Compliance Type</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Total Amount</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">Provident Fund (PF)</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${totalPF.toLocaleString('en-IN')}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; color: #059669; font-weight: bold;">Compliant</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">ESIC</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${totalESIC.toLocaleString('en-IN')}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; color: #059669; font-weight: bold;">Compliant</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">Professional Tax (PT)</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${totalPT.toLocaleString('en-IN')}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; color: #059669; font-weight: bold;">Compliant</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateSimplePDFFooter(metadata) {
            return `
                <div style="background: #f8fafc; border-top: 2px solid #e2e8f0; padding: 15px; margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
                    <div style="margin-bottom: 5px; font-weight: bold; color: #1e293b;">Shishuraksha Children's Hospital</div>
                    <div style="margin-bottom: 5px;">Payroll Management System</div>
                    <div style="font-style: italic;">This report contains confidential information and is intended for authorized personnel only.</div>
                    <div style="margin-top: 10px;">Generated: ${metadata.generationDate}</div>
                </div>
            `;
        }
        
        function getCurrentDateString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        
        function generatePDFHeader(metadata) {
            return `
                <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 30px; margin-bottom: 30px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                🏥
                            </div>
                            <div>
                                <h1 style="font-size: 28px; font-weight: bold; margin: 0 0 8px 0; letter-spacing: 0.5px;">SHISHURAKSHA CHILDREN'S HOSPITAL</h1>
                                <p style="font-size: 16px; margin: 0; opacity: 0.9;">Comprehensive Payroll Report</p>
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 12px;">
                            <div style="margin-bottom: 8px;"><strong>Report Period:</strong> ${metadata.reportPeriod}</div>
                            <div style="margin-bottom: 8px;"><strong>Generated:</strong> ${metadata.generationDate}</div>
                            <div><strong>Report ID:</strong> ${metadata.reportId}</div>
                        </div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 12px 20px; border-radius: 6px; text-align: center; font-size: 11px; font-weight: 500;">
                        🛡️ CONFIDENTIAL DOCUMENT - FOR AUTHORIZED PERSONNEL ONLY
                    </div>
                </div>
            `;
        }
        
        function generatePDFExecutiveSummary(metadata) {
            const totalDeductions = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pf) || 0) + (parseFloat(emp.esic) || 0) + (parseFloat(emp.pt) || 0), 0);
            
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0; display: flex; align-items: center; gap: 10px;">
                            📊 Executive Summary
                        </h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, white 100%); border-left: 4px solid #1e40af; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; color: #1e40af; margin-bottom: 8px;">👥</div>
                            <h3 style="font-size: 28px; font-weight: bold; color: #1e293b; margin: 0 0 4px 0;">${metadata.totalEmployees}</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0 0 8px 0;">Total Employees</p>
                            <div style="font-size: 10px; color: #059669; display: flex; align-items: center; gap: 4px;">
                                ↗️ +3 from last month
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #d1fae5 0%, white 100%); border-left: 4px solid #059669; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; color: #059669; margin-bottom: 8px;">💰</div>
                            <h3 style="font-size: 28px; font-weight: bold; color: #1e293b; margin: 0 0 4px 0;">₹${metadata.totalGrossPayroll.toLocaleString('en-IN')}</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0 0 8px 0;">Gross Payroll</p>
                            <div style="font-size: 10px; color: #059669; display: flex; align-items: center; gap: 4px;">
                                ↗️ +12.5% YoY
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, white 100%); border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; color: #3b82f6; margin-bottom: 8px;">🏦</div>
                            <h3 style="font-size: 28px; font-weight: bold; color: #1e293b; margin: 0 0 4px 0;">₹${metadata.totalNetPayroll.toLocaleString('en-IN')}</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0 0 8px 0;">Net Payroll</p>
                            <div style="font-size: 10px; color: #3b82f6; display: flex; align-items: center; gap: 4px;">
                                🐷 ₹${totalDeductions.toLocaleString('en-IN')} in deductions
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fed7aa 0%, white 100%); border-left: 4px solid #d97706; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; color: #d97706; margin-bottom: 8px;">🧮</div>
                            <h3 style="font-size: 28px; font-weight: bold; color: #1e293b; margin: 0 0 4px 0;">₹${metadata.averageSalary.toLocaleString('en-IN')}</h3>
                            <p style="font-size: 12px; color: #64748b; margin: 0 0 8px 0;">Average Salary</p>
                            <div style="font-size: 10px; color: #d97706; display: flex; align-items: center; gap: 4px;">
                                📊 Above industry avg
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1e40af; margin: 0 0 15px 0;">Key Insights</h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 11px; line-height: 1.5;">
                                <span style="position: absolute; left: 0; color: #3b82f6;">▶</span>
                                <strong>Department Distribution:</strong> Medical Staff (${Math.round((currentData.filter(e => e.department === 'Medical Staff').length / currentData.length) * 100)}%), IT, Administration, Support
                            </li>
                            <li style="margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 11px; line-height: 1.5;">
                                <span style="position: absolute; left: 0; color: #3b82f6;">▶</span>
                                <strong>Attendance Rate:</strong> 96.5% overall attendance for ${metadata.reportPeriod}
                            </li>
                            <li style="margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 11px; line-height: 1.5;">
                                <span style="position: absolute; left: 0; color: #3b82f6;">▶</span>
                                <strong>Compliance Status:</strong> All PF, ESIC, and PT deductions processed correctly
                            </li>
                            <li style="padding-left: 20px; position: relative; font-size: 11px; line-height: 1.5;">
                                <span style="position: absolute; left: 0; color: #3b82f6;">▶</span>
                                <strong>Cost Analysis:</strong> Total deductions represent ${((totalDeductions / metadata.totalGrossPayroll) * 100).toFixed(1)}% of gross payroll
                            </li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function generatePDFEmployeeDetails() {
            let tableRows = '';
            currentData.forEach(emp => {
                const allowances = (parseFloat(emp.hra) || 0) + (parseFloat(emp.conveyance) || 0) + (parseFloat(emp.otherAllowances) || 0);
                tableRows += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 8px; font-size: 9px;">${emp.empId}</td>
                        <td style="padding: 8px; font-size: 9px; font-weight: 600;">${emp.name}</td>
                        <td style="padding: 8px; font-size: 9px;">${emp.department}</td>
                        <td style="padding: 8px; font-size: 9px;">${emp.designation}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.basicSalary) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${allowances.toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right; font-weight: 600;">₹${(parseFloat(emp.grossSalary) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.pf) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.esic) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.pt) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right;">₹${(parseFloat(emp.advance) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right; font-weight: 600; color: #059669;">₹${(parseFloat(emp.netPay) || 0).toLocaleString('en-IN')}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0;">👥 Employee Payroll Details</h2>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead style="background: #1e40af; color: white;">
                            <tr>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Emp ID</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Employee Name</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Department</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Designation</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Basic Salary</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Allowances</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Gross Salary</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">PF</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">ESIC</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">PT</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Advance</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Net Pay</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generatePDFDepartmentAnalysis() {
            const departments = {};
            currentData.forEach(emp => {
                if (!departments[emp.department]) {
                    departments[emp.department] = {
                        count: 0,
                        totalGross: 0,
                        totalNet: 0
                    };
                }
                departments[emp.department].count++;
                departments[emp.department].totalGross += parseFloat(emp.grossSalary) || 0;
                departments[emp.department].totalNet += parseFloat(emp.netPay) || 0;
            });
            
            let deptCards = '';
            Object.keys(departments).forEach(dept => {
                const data = departments[dept];
                const avgSalary = Math.floor(data.totalGross / data.count);
                
                deptCards += `
                    <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1e40af; margin: 0 0 15px 0;">${dept}</h3>
                        <div style="display: grid; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-size: 11px; color: #64748b;">Employees:</span>
                                <span style="font-size: 11px; font-weight: 600; color: #1e293b;">${data.count}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-size: 11px; color: #64748b;">Total Gross:</span>
                                <span style="font-size: 11px; font-weight: 600; color: #1e293b;">₹${data.totalGross.toLocaleString('en-IN')}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="font-size: 11px; color: #64748b;">Avg Salary:</span>
                                <span style="font-size: 11px; font-weight: 600; color: #1e293b;">₹${avgSalary.toLocaleString('en-IN')}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0;">🏢 Department Analysis</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        ${deptCards}
                    </div>
                </div>
            `;
        }
        
        function generatePDFAttendanceSummary() {
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0;">📅 Attendance Summary</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid #3b82f6;">
                            <h3 style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 0 0 8px 0;">96.5%</h3>
                            <p style="font-size: 10px; color: #64748b; margin: 0;">Overall Attendance Rate</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid #3b82f6;">
                            <h3 style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 0 0 8px 0;">22.3</h3>
                            <p style="font-size: 10px; color: #64748b; margin: 0;">Average Working Days</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid #3b82f6;">
                            <h3 style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 0 0 8px 0;">4</h3>
                            <p style="font-size: 10px; color: #64748b; margin: 0;">Total Holidays</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid #3b82f6;">
                            <h3 style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 0 0 8px 0;">${currentData.reduce((sum, emp) => sum + (parseInt(emp.overtimeHours) || 0), 0)}</h3>
                            <p style="font-size: 10px; color: #64748b; margin: 0;">Total Overtime Hours</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generatePDFBankTransfers() {
            let bankRows = '';
            currentData.forEach(emp => {
                const maskedAccount = maskBankAccount(emp.bankAccount);
                bankRows += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 8px; font-size: 9px;">${emp.empId}</td>
                        <td style="padding: 8px; font-size: 9px; font-weight: 600;">${emp.name}</td>
                        <td style="padding: 8px; font-size: 9px;">${maskedAccount}</td>
                        <td style="padding: 8px; font-size: 9px;">${emp.ifscCode || 'N/A'}</td>
                        <td style="padding: 8px; font-size: 9px;">${emp.bankName || 'N/A'}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: right; font-weight: 600;">₹${(parseFloat(emp.netPay) || 0).toLocaleString('en-IN')}</td>
                        <td style="padding: 8px; font-size: 9px; text-align: center;">
                            <span style="background: #d1fae5; color: #059669; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 600;">Ready</span>
                        </td>
                    </tr>
                `;
            });
            
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0;">💰 Bank Transfer Details</h2>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead style="background: #1e40af; color: white;">
                            <tr>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Emp ID</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Employee Name</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Bank Account</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">IFSC Code</th>
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 10px;">Bank Name</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 10px;">Net Amount</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600; font-size: 10px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bankRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generatePDFCompliance() {
            const totalPF = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pf) || 0), 0);
            const totalESIC = currentData.reduce((sum, emp) => sum + (parseFloat(emp.esic) || 0), 0);
            const totalPT = currentData.reduce((sum, emp) => sum + (parseFloat(emp.pt) || 0), 0);
            const pfCoveredCount = currentData.filter(emp => (parseFloat(emp.pf) || 0) > 0).length;
            const ptLiableCount = currentData.filter(emp => (parseFloat(emp.pt) || 0) > 0).length;
            
            return `
                <div style="margin-bottom: 40px;">
                    <div style="background: #dbeafe; padding: 20px; border-bottom: 3px solid #3b82f6; margin-bottom: 20px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e40af; margin: 0;">✅ Compliance Report</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid #1e40af; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="font-size: 14px; font-weight: 600; color: #1e40af; margin: 0 0 15px 0;">Provident Fund (PF)</h3>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Total PF Deduction:</strong> ₹${totalPF.toLocaleString('en-IN')}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employer Contribution:</strong> ₹${totalPF.toLocaleString('en-IN')}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employees Covered:</strong> ${pfCoveredCount}/${currentData.length}</div>
                            <div style="font-size: 11px;"><strong>Status:</strong> <span style="background: #d1fae5; color: #059669; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">Compliant</span></div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid #059669; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="font-size: 14px; font-weight: 600; color: #1e40af; margin: 0 0 15px 0;">ESIC</h3>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employee Contribution:</strong> ₹${totalESIC.toLocaleString('en-IN')}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employer Contribution:</strong> ₹${Math.floor(totalESIC * 3.5).toLocaleString('en-IN')}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employees Covered:</strong> ${currentData.length}/${currentData.length}</div>
                            <div style="font-size: 11px;"><strong>Status:</strong> <span style="background: #d1fae5; color: #059669; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">Compliant</span></div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid #d97706; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="font-size: 14px; font-weight: 600; color: #1e40af; margin: 0 0 15px 0;">Professional Tax (PT)</h3>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Total PT Deduction:</strong> ₹${totalPT.toLocaleString('en-IN')}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Employees Liable:</strong> ${ptLiableCount}/${currentData.length}</div>
                            <div style="font-size: 11px; margin-bottom: 8px;"><strong>Exempted:</strong> ${currentData.length - ptLiableCount} (Below threshold)</div>
                            <div style="font-size: 11px;"><strong>Status:</strong> <span style="background: #d1fae5; color: #059669; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">Compliant</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generatePDFFooter(metadata) {
            return `
                <div style="background: #f8fafc; border-top: 2px solid #e2e8f0; padding: 20px; margin-top: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #64748b;">
                        <div>
                            <div style="font-weight: 600; color: #1e293b;">Shishuraksha Children's Hospital</div>
                            <div>Payroll Management System</div>
                        </div>
                        <div style="text-align: center; font-style: italic;">
                            This report contains confidential information and is intended for authorized personnel only.
                        </div>
                        <div style="text-align: right;">
                            <div>Generated: ${metadata.generationDate}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function maskBankAccount(accountNumber) {
            if (!accountNumber) return 'N/A';
            
            const str = accountNumber.toString();
            if (str.length <= 4) return str;
            
            const start = str.substring(0, 4);
            const end = str.substring(str.length - 4);
            const masked = 'X'.repeat(str.length - 8);
            
            return `${start}${masked}${end}`;
        }
        
        function exportToExcel() {
            if (!currentData || currentData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                showNotification('Excel export not available', 'error');
                return;
            }
            
            updateStatus('Exporting to Excel...', 'warning');
            
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(currentData);
                
                XLSX.utils.book_append_sheet(wb, ws, 'Payroll Data');
                
                const fileName = `Payroll_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                updateStatus('Excel file exported', 'success');
                showNotification('Excel file downloaded!', 'success');
            } catch (error) {
                updateStatus('Excel export failed', 'error');
                showNotification('Excel export failed', 'error');
            }
        }
        
        function downloadSampleFile() {
            const sampleData = [
                {
                    empId: "EMP001",
                    name: "Dr. John Doe",
                    department: "Medical Staff",
                    designation: "Senior Doctor",
                    basicSalary: 50000,
                    hra: 20000,
                    conveyance: 2000,
                    otherAllowances: 3000,
                    grossSalary: 75000,
                    pf: 6000,
                    esic: 563,
                    pt: 200,
                    advance: 0,
                    netPay: 68237,
                    bankAccount: "1234567890123456",
                    ifscCode: "HDFC0001234",
                    bankName: "HDFC Bank"
                }
            ];
            
            const dataStr = JSON.stringify(sampleData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'sample_payroll_data.json';
            link.click();
            
            showNotification('Sample file downloaded', 'success');
        }
        
        function toggleFullscreen() {
            const previewContainer = document.getElementById('previewContainer');
            if (previewContainer.requestFullscreen) {
                previewContainer.requestFullscreen();
            }
        }
        
        function refreshPreview() {
            if (isPreviewGenerated) {
                generatePreview();
            }
        }
        
        function updateStatus(message, type) {
            const statusPanel = document.getElementById('statusPanel');
            const statusContent = document.getElementById('statusContent');
            
            if (statusPanel && statusContent) {
                statusPanel.classList.remove('hidden');
                
                const indicator = type === 'success' ? 'status-success' : 
                               type === 'warning' ? 'status-warning' : 'status-error';
                
                statusContent.innerHTML = `
                    <div class="flex items-center">
                        <span class="status-indicator ${indicator}"></span>
                        ${message}
                    </div>
                `;
            }
        }
        
        function showProgress(show) {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                if (show) {
                    progressContainer.classList.remove('hidden');
                } else {
                    progressContainer.classList.add('hidden');
                }
            }
        }
        
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (progressPercent) progressPercent.textContent = percent + '%';
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all transform translate-x-full`;
            
            const bgColor = type === 'success' ? 'bg-green-500' :
                           type === 'warning' ? 'bg-yellow-500' :
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className += ` ${bgColor} text-white`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>